${head}
<!-- ***************************************************************** -->
<!--                                                                   -->
<!-- IBM Confidential                                                  -->
<!--                                                                   -->
<!-- OCO Source Materials                                              -->
<!--                                                                   -->
<!-- Copyright IBM Corp. 2011, 2015                                    -->
<!--                                                                   -->
<!-- The source code for this program is not published or otherwise    -->
<!-- divested of its trade secrets, irrespective of what has been      -->
<!-- deposited with the U.S. Copyright Office.                         -->
<!--                                                                   -->
<!-- ***************************************************************** -->
<title>Show More Datastore Test</title>
${script:lconn.core.config.services}
${script:com.ibm.social.ee.test.ds.TestDsTotalKnown}
${script:com.ibm.social.ee.test.ds.TestDsTotalNotKnown}
${script:com.ibm.social.ee.data.ShowMoreDataStore}

<script>
(function () {
	
   var data;
   var currentSize;
   var itemsList;
   var dsCountAvail;
   var dsCountUnavail;
   var dsShowMoreCountAvail;
   var dsShowMoreCountUnavail;
   
	function generateData (size) {
		var data = [];
		for (var i = 0; i < size; i++) {
			var item = { id: (i+1) + "_" + (new Date()).getTime(), name: "item " + (i+1), date: new Date() };
			data.push(item);
			/*
			var start = (new Date()).getTime();
			do {
				var now = (new Date()).getTime();
				if (now - start > 100)
					break;				
			} while (true);
			*/
		}
		return data;
	}
	
	function deleteItem (item, li) {
		dojo.destroy(li);
		data.splice(dojo.indexOf(data, item), 1);
	}
	
	function appendItems (link) {
		var span = dojo.create("div", { }, link, "after");
		dojo.create("label", { innerHTML: "Enter number of items: " }, span);
		var input = dojo.create("input", { type: "text", value:"5" }, span);
		var btn = dojo.create("button", { innerHTML: "Create" }, span);
		var btn2 = dojo.create("button", { innerHTML: "Cancel" }, span);
		dojo.connect(btn2, "onclick", null, function() {
			dojo.destroy(span);
		});
		var conn = dojo.connect(btn, "onclick", null, function () {
			var nItems = parseInt(input.value);
			var ul = itemsList;
			for (var i = 0; i < nItems; i++) {
				var ndx = currentSize + i + 1;
				var item = { id: ndx + "_" + (new Date()).getTime(), name: "item " + ndx, date: (new Date()) };
				data.push(item);
				var li = dojo.create("li", { }, ul);
				dojo.create("span", { innerHTML: "item id=" + item.id + ", name=" + item.name + ", date: " + item.date + " " }, li);
		      var a = dojo.create("a", { innerHTML: "Delete", href:"javascript:;", className: "lotusLink"}, li);
		      dojo.connect(a, "onclick", null, dojo.hitch(null, deleteItem, item, li));
			}
			currentSize += nItems;
			dojo.disconnect(conn);
			dojo.destroy(span);
		});
	}
	
	function displayData (items) {
		var dsData = dojo.byId("dsData");
		dojo.empty(dsData);
		var ul = itemsList = dojo.create("ul", { }, dsData);
		for (var i = 0; i < data.length; i++) {
			var li = dojo.create("li", { }, ul);
			dojo.create("span", { innerHTML: "item id=" + data[i].id + ", name=" + data[i].name + ", date:" + data[i].date + " " }, li);
			var a = dojo.create("a", { innerHTML: "Delete", href:"javascript:;", className: "lotusLink"}, li);
			dojo.connect(a, "onclick", null, dojo.hitch(null, deleteItem, data[i], li));
		}
		var a = dojo.create("a", { innerHTML: "Append...", href:"javascript:;" }, dsData);
		dojo.connect(a, "onclick", null, dojo.hitch(null, appendItems, a));
	}

	dojo.addOnLoad(function() {
		dojo.connect(dojo.byId("generateDs"), "onclick", null, function () {
			var dsSize = parseInt(dojo.byId("dsSize").value);
			data = generateData (dsSize);
			currentSize = dsSize;			
			dsCountAvail = new com.ibm.social.ee.test.ds.TestDsTotalKnown(data);
			dsCountUnavail = new com.ibm.social.ee.test.ds.TestDsTotalNotKnown(data);
			dsShowMoreCountAvail = new com.ibm.social.ee.data.ShowMoreDataStore({ ds: dsCountAvail, countAvailable: true, dateAttr: "date", idAttr: "id" });
			dsShowMoreCountUnavail = new com.ibm.social.ee.data.ShowMoreDataStore({ ds: dsCountUnavail, countAvailable: false, dateAttr: "date", idAttr: "id" });
			displayData(data);
			dojo.byId("dsTest").style.display = "";
		});
		
		dojo.connect(dojo.byId("dsFetch"), "onclick", null, function () {
			var dsType = dojo.byId("dsType").value;
			var ds = null;
			switch (dsType) {
			   case "knownTotal": ds = dsCountAvail; break;
			   case "unknownTotal": ds = dsCountUnavail; break;
            case "knownTotalSM": ds = dsShowMoreCountAvail; break;
            case "unknownTotalSM": ds = dsShowMoreCountUnavail; break;
			}
			var start = parseInt(dojo.byId("dsStart").value);
			var count = parseInt(dojo.byId("dsCount").value);
			var descending = dojo.byId("dsSort").value == "descending";
			var sort = [ { attributeName: "id",  descending: descending}];
			
			var results = dojo.byId("dsResults");
			dojo.empty(results);
			
		   ds.fetch ({
				start: start,
				count: count,
				sort: sort,
				onBegin: function (count, request) {
					dojo.create("span", { innerHTML: "Total results: " + count + ", hasMore: " + request.hasMore }, results);
					
				},
				onComplete: function (items, request) {
					var ul = dojo.create("ul", { }, results);
					for (var i = 0; i < items.length; i++) {
						var li = dojo.create("li", { innerHTML: "item id=" + items[i].id + ", name=" + items[i].name + ", date: " + items[i].date + " " }, ul);
					}
				},
				onError: function (error, request) {
					dojo.create("span", { innerHTML: " -- " + error, style: "color:red" }, results);
				}
			});
			
		});
	});
})();
</script>
${endhead}

<div class="lotusMain">
<div class="lotusContent">

<table>
<tr>
<td style="vertical-align:top">
<div>
<h3>Generate Datastore</h3>
<label for="dsSize">Number of items</label><input id="dsSize" type="text" value="10"><br />
<button id="generateDs">Go</button>
</div>

<div id="dsData">
   
</div>
</td>
<td style="vertical-align:top">
<div id="dsTest" style="display:none">
<label>Datastore: </label>
<select id="dsType">
<option value="knownTotal">Total Count Known</option>
<option value="unknownTotal">Total Count Not Known</option>
<option value="knownTotalSM">Total Count Known - Show More</option>
<option value="unknownTotalSM">Total Count Not Known - Show More</option>
</select>
<br />
<label>Start Index: </label><input type="text" id="dsStart" value="0"><br />
<label>Count: </label><input type="text" id="dsCount" value="10"><br />
<label>Sort: </label><select id="dsSort"><option vlaue="ascending">Ascending</option><option value="descending">Descending</option></select><br />
<button id="dsFetch">Fetch</button>
<div id="dsResults"></div>
</div>
</td>
</tr>
</table>

</div>
</div>

</body>
${end}