/* Copyright IBM Corp. 2015  All Rights Reserved.                    */
define("dojo dojo/_base/window dojo/_base/declare dojo/aspect dojo/i18n!ic-ee/nls/socialEEStrings dojo/_base/array dojo/dom-class dojo/_base/lang dojo/dom dojo/dom-construct dojo/query dojo/text!ic-ee/widget/templates/History.html dojo/topic dijit/_Templated dijit/_Widget ic-incontext/util/DateFormat ic-ee/data/HistoryDataStore ic-core/globalization/bidiUtil ic-core/auth ic-ee/data/OpenSocialRoutes ic-ee/util/misc ic-incontext/util/html ic-incontext/util/text".split(" "),function(I,p,x,r,s,y,t,h,
n,a,z,A,u,B,C,D,E,F,v,G,w,q,H){return x("com.ibm.social.ee.widget.History",[C,B],{nls:s,_strings:s.HISTORY,_ds:null,net:null,url:null,uuid:null,loading:null,disableSort:!0,disablePaging:!1,focusDiv:null,templateString:A,postCreate:function(){this.inherited(arguments);this.rollupUrl||(this.rollupUrl=(new G(this.routeOptions)).getRollupUrl(this.uuid));this._ds=new E({net:this.net,disableSort:this.disableSort,url:this.rollupUrl});this.own(r.after(this,"_showEmptyMsg",h.hitch(this,"onDisplayChange"),
!0));this.own(r.after(this,"_showErrorMsg",h.hitch(this,"onDisplayChange"),!0));this._getHistoryItems(!0)},_getHistoryItems:function(a){this._showLoading();this._ds.fetch({query:{uuid:this.uuid},onComplete:h.hitch(this,function(d,b){d?d.items?this._showHistoryUI(d.items,d.moreExists,a):d.prevItem?this._doNothing():this._showEmptyMsg():this._showErrorMsg();if(a)this.onLoaded();else this.onDisplayChange();u.publish("com/ibm/social/ee/data/loaded","");var e=h.hitch(this,function(){this.onDisplayChange()});
setTimeout(e,100)}),onError:h.hitch(this,function(d,b){this._showErrorMsg(a,d)})})},scrollToBottom:function(){window.setTimeout(function(){u.publish("com/ibm/social/ee/event/scrollBottom","")},0)},onLoaded:function(){},_doNothing:function(){this.loading.style.display="none"},_showEmptyMsg:function(){var f=a.create("div",{},this.empty);f.appendChild(p.doc.createTextNode(this._strings.NO_HISTORY));t.add(f,"lconnEmpty");this.empty.style.display="";this.loading.style.display="none"},_showMoreHistory:function(){this.moreLink.style.display=
"none";this._getHistoryItems(!1)},_showLoading:function(){a.empty(this.loading);q.showLoading(this.loading);this.loading.style.display="";this.onDisplayChange();this.scrollToBottom()},_showHistoryUI:function(f,d,b){var e=this,k=p.doc,g=!0;y.forEach(f,function(d,f){var b=e._ds.getValue(d,"author"),l=e._ds.getValue(d,"shortTitle");v.getUser()&&v.getUser().isExternal&&(l=q.removeProfileLinks(l));var h=(new D(e._ds.getValue(d,"published"))).formatByAge(e._strings.TIMESTAMP.CREATED),c=g?"lotusCommentItem lotusFirst":
"lotusCommentItem";g=!1;c=a.create("li",{className:c},e.listCtnr);c=a.create("div",{className:"lotusPost eeCommentContent",tabindex:"0"},c);0===f&&(e.focusDiv=c);var m=a.create("div",{className:"lotusPostAuthorInfo"},c),m=a.create("div",{className:"lotusPostAvatar"},m);e.generateUserImage&&(b={name:b.name,id:w.getItemId(b.id)},e.generateUserImage(b,m,35,35,null,{imagePop:!1,title:e._strings.PROFILE_TITLE,generateLink:!1}));m=dijit.getUniqueId("eeComment");b=a.create("div",{className:"lotusPostContent",
id:m},c);c.setAttribute("aria-labelledby",m);c=a.create("div",{className:"lotusPostAction"},b);c.innerHTML=l;H.breakStringHTML(c,15);l=z("a",c);for(c=0;c<l.length;c++)l[c].setAttribute("target","_blank"),t.add(l[c],"eeActionLinks");a.create("div",{className:"lotusMeta"},b).appendChild(k.createTextNode(h))});this.main.style.display="";this.empty.style.display="none";this.moreLink.style.display=!d||this.disablePaging?"none":"";this.disableSort||(this.sortNode.style.display="");this.loading.style.display=
"none";F.enforceTextDirectionOnPage(this.listCtnr.parentNode);this.focusDiv&&!b&&this.focusDiv.focus();w.addMessageToNewWindowLinks()},_showErrorMsg:function(f,d){a.empty(this.error);var b=a.create("span"),e=p.doc,k=this;q.substitute(e,b,this.prevItem?this._strings.ERROR_ADDTL:this._strings.ERROR,{again:function(){var b=a.create("a");b.href="#";b.setAttribute("role","button");b.title=k._strings.ERROR_AGAIN_TITLE;b.appendChild(e.createTextNode(k._strings.ERROR_AGAIN));k.connect(b,"onclick",h.hitch(k,
k._tryAgain,f));return b}});var g;f?(g=a.create("div",{className:"lconnEmpty",role:"alert"},this.error),g.appendChild(b)):(g=a.create("div",{className:"lotusMessage2",role:"alert"},this.error),g.style.margin="10px 0 0 0",a.create("img",{className:"lconnSprite lconnSprite-iconError16",alt:this.ERROR_ALT,title:this.ERROR_ALT,src:this._blankGif},g).style.marginRight="10px",a.create("span",{},g).appendChild(b));this.error.style.display="";this.loading.style.display="none"},_tryAgain:function(a){this._getHistoryItems(a);
this._clearErrors()},_sort:function(){a.empty(this.listCtnr);this.main.style.display="none";this._clearErrors();this.disablePaging||(this.moreLink.style.display="none")},_clearErrors:function(){this.error.style.display="none";a.empty(this.error)},_sortAsc:function(){n.byId("sortAsc").style.display="";n.byId("sortDesc").style.display="none";this._sort();this._ds.switchSort(!1);this._getHistoryItems()},_sortDesc:function(){n.byId("sortDesc").style.display="";n.byId("sortAsc").style.display="none";this._sort();
this._ds.switchSort(!0);this._getHistoryItems()},onDisplayChange:function(){}})});
