/* Copyright IBM Corp. 2015  All Rights Reserved.                    */
define(["dojo/topic"],function(n){define("dojo dojo/_base/array dojo/_base/declare dojo/i18n!ic-as/nls/activitystream dojo/dom-style dojo/dom-construct dojo/_base/window dojo/dom-class dojo/dom dojo/dom-geometry dojo/_base/lang dojo/json dojo/string dojo/topic ic-as/ActivityStream ic-as/constants/events ic-as/nav/ASHeader ic-as/nav/ASSideNav ic-homepage/as/message/MessageContainer".split(" "),function(n,k,p,q,l,m,r,d,b,s,e,t,u,g,v,h,w,x,y){return p("com.ibm.social.as.gadget.ASComponentUtil",null,
{strings:null,cfgUtil:null,rebuildConfig:!1,configComplete:!1,backToMainSubscription:null,constructor:function(){this.strings=q},initLogger:function(){window.as_console_debug=asc.isDebug||asc.isDebugFF&&console&&console.debug?asc.log:function(){}},initAS:function(){as_console_debug("ASComponentUtil - initAS - entering");asc.resize={};asc.resize.curHeight=0;asc.resize.steps=[500,1E3,3500,5E3];asc.resize.curStep=0;asc.resize.timer=null;window.ibmConfig=window.ibmConfig||{};window.ibmConfig.versionStamp=
asc.versionStamp_;as_console_debug("ASComponentUtil - initAS - gettin' the config");this.cfgUtil=new com.ibm.social.as.gadget.ActivityStreamConfigUtil;this.buildConf();this.handleMinMaxWidth();as_console_debug("ASComponentUtil - initAS - exiting")},handleMinMaxWidth:function(){asc.asMaxWidth&&l.set(b.byId("lotusMain"),"maxWidth",asc.asMaxWidth);asc.asMinWidth&&l.set(b.byId("lotusFrame"),"minWidth",asc.asMinWidth)},buildConf:function(){var a,c=e.hitch(this,function(a){asc.log("Error retrieving config",
a);a.noUser?(b.byId("errorDiv").innerHTML=u.substitute(this.strings.noUser,{0:asc.actionEmail})+"<br />",m.place((new com.ibm.social.as.gadget.nav.BackToMainButton).domNode,"errorDiv")):b.byId("errorDiv").innerHTML=this.strings.invalidASConfig;d.remove(b.byId("errorDiv"),"lotusHidden");d.add(b.byId("loadingDiv"),"lotusHidden");this.configComplete=!0});this.configComplete=!1;try{a=asc.actionEmail?this.cfgUtil.buildConfigFromEmail(asc.actionEmail):asc.asFeed?this.cfgUtil.buildConfigFromFeed(asc.asFeed):
asc.asMode&&"profile"==asc.asMode?this.cfgUtil.getASConfig({mode:"profile",profileId:"FIXME",singleEntryId:"FIXME"}):asc.asConfig?this.cfgUtil.augmentConfig(t.parse(asc.asConfig)):this.cfgUtil.getASConfig({mode:"home"}),a.then(e.hitch(this,function(a){this.rebuildConfig?(this.rebuildConfig=!1,this.buildConf()):(a.eeManager&&(a.eeManager="com.ibm.social.as.ee.EEManagerURLLauncher"),!1===asc.isInlineCommentingEnabled&&(a.inlineCommentingEnabled=asc.isInlineCommentingEnabled),asc.count&&(a.defaultUrlTemplateValues?
a.defaultUrlTemplateValues.count=asc.count:a.defaultUrlTemplateValues={count:asc.count}),as_console_debug("ASComponentUtil - initAS - got config"),asc.cfg=a,window.activityStreamConfig=a,new y({},b.byId("messageContainer")),new v({configObject:a,domNode:b.byId("activityStream"),isGadget:!0,selectedState:"imfollowing"}),"wide"===asc.type&&(asc.showHeader&&!asc.actionEmail&&(as_console_debug("ASComponentUtil - initAS - adding header"),new w({configObject:a},b.byId("asheader"))),1<asc.util.getViewCount()&&
(as_console_debug("ASComponentUtil - initAS - adding sidenav"),new x({configObject:a,useHrefs:!1},b.byId("viewsidenav")),d.remove(b.byId("lotusColLeft"),"lotusHidden"),d.remove(b.byId("viewsidenav"),"lotusMenuSection"),d.add(b.byId("viewsidenav"),"lotusMenu"))),as_console_debug("ASComponentUtil - initAS - creating AS dijit"),"undefined"===typeof asc.actionEmail&&asc.showSharebox&&lconn.core.config.services.microblogging&&(!asc.showSharebox||asc.shareboxBoardId&&asc.shareboxPostType||"profile"!==asc.asMode||
"FIXME"==a.userInfo.id||(asc.shareboxBoardId="FIXME",asc.shareboxPostType="PROFILES_MESSAGE"),this.showInputForm()),a.views.actionRequired&&asc.util.initialiseActionRequiredBadge(),d.remove(b.byId("lotusMain"),"lotusHidden"),d.add(b.byId("loadingDiv"),"lotusHidden"),this.configComplete=!0)}),c)}catch(f){c(f)}},showInputForm:function(){as_console_debug("ASComponentUtil - showInputForm - entering");var a=activityStreamAbstractHelper.getMBSettingsUrl(),c=this;activityStreamAbstractHelper.xhrGet({url:a,
handleAs:"json",load:function(a){as_console_debug("ASComponentUtil - showInputForm - loaded, ",arguments);params=a&&a.entry;c.loadShareBox(params);g.publish(h.MICROBLOGCONFIGLOADED,params)},error:function(){as_console_debug("ASComponentUtil - showInputForm - error, ",arguments)}});as_console_debug("ASComponentUtil - showInputForm - exiting - returning nothing: ")},asResize:function(){asc.resize.timer&&(clearTimeout(asc.resize.timer),asc.resize.timer=null);asc.resize.curStep=-1;this.doResizeStep()},
loadShareBox:function(a){a&&(a.maxNumberChars=a["com.ibm.connections.ublog.microblogEntryMaxChars"],a.boardId="@me",a.postType=lconn.news.microblogging.sharebox.Context.SU_CONTEXT,asc.shareboxBoardId&&asc.shareboxPostType&&(a.boardId=asc.shareboxBoardId,a.postType=asc.shareboxPostType),a["com.ibm.connections.ublog.AtMentionsEnabled"]=a["com.ibm.connections.ublog.AtMentionsEnabled"]?"true":"false",(new lconn.news.microblogging.sharebox.InputForm({params:a,UBLOG_RELATIVE_PATH:window.activityStreamAbstractHelper.getUblogRelativePath()},
b.byId("inputForm"))).removeFilePicker())},doResizeStep:function(){as_console_debug("ASComponentUtil - doResizeStep - entering, asc.resize: ",asc.resize);asc.resize.curStep++;if(asc.resize.curStep>=asc.resize.steps.length)clearTimeout(asc.resize.timer),asc.resize.timer=null;else{var a=Math.floor(s.position(b.byId("lotusFrame")).h);a!=asc.resize.curHeight&&(asc.resize.curHeight=a,gadgets.window.adjustHeight(),as_console_debug("ASComponentUtil - doResizeStep - resizing to: ",asc.resize.curHeight));
asc.resize.timer=setTimeout(e.hitch(this,"doResizeStep"),asc.resize.steps[asc.resize.curStep]);as_console_debug("ASComponentUtil - doResizeStep - exiting, asc.resize: ",asc.resize)}},getViewCount:function(){var a=0;if(asc&&asc.cfg&&asc.cfg.views)for(var c in asc.cfg.views)asc.cfg.views.hasOwnProperty(c)&&a++;as_console_debug("ASComponentUtil - getViewCount - viewCount: ",a);return a},doAction:function(a){asc.log("showAS action fired, args : ",arguments);var c=this.retrieveEmailFromActionSelection(a);
c&&(asc.actionEmail=c,this.destroyAndRebuildWidgets(),this.backToMainSubscription=this.backToMainSubscription||g.subscribe(h.BACKTOMAIN,e.hitch(this,"undoAction")))},retrieveEmailFromActionSelection:function(a){asc.log("ASComponentUtil - retrieveEmailFromActionSelection, args : ",arguments);var c=null;if(a){var b=null;k.forEach(a,function(a){!b&&a&&a.dataObject&&"opensocial.Person"===a.type&&(b=a.dataObject)});if(b&&b.emails){var d=null,e=null;k.forEach(b.emails,function(a){a&&a.value&&"string"===
typeof a.value&&(d||(d=a.value),"true"===a.primary&&(e=a.value))});c=e||d||null}}asc.log("ASComponentUtil - retrieveEmailFromActionSelection, email : ",c);return c},undoAction:function(){delete asc.actionEmail;this.destroyAndRebuildWidgets();this.backToMainSubscription.remove()},destroyAndRebuildWidgets:function(){d.add(b.byId("errorDiv"),"lotusHidden");d.remove(b.byId("loadingDiv"),"lotusHidden");d.add("lotusColLeft","lotusHidden");if(this.configComplete){for(var a,c=dijit.findWidgets(r.body()),
f=0,e=c.length;f<e;f++)"undefined"!==typeof c[f]&&(a=c[f].domNode.parentElement||c[f].domNode.parentNode,c[f].destroyRecursive(),m.create("div",{id:c[f].id},a));this.buildConf()}else this.rebuildConfig=!0},initialiseActionRequiredBadge:function(){setTimeout(function(){activityStreamAbstractHelper.xhrGet({url:activityStreamAbstractHelper.getActionRequiredInitUrl(),handleAs:"json",load:function(a){a&&a.totalResults&&g.publish(h.ACTIONREQUIREDBADGEUPDATE,a.totalResults)},error:function(a){as_console_debug(a)}})},
100)}})})});
