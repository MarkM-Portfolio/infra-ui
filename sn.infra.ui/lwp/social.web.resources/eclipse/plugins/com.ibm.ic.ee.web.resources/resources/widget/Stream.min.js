/* Copyright IBM Corp. 2015  All Rights Reserved.                    */
define("dojo dojo/dom-construct dojo/_base/array dojo/dom-class dojo/dom dojo/_base/declare dojo/_base/window dojo/_base/lang dojo/on dojo/request dojo/string dojo/text!ic-ee/widget/templates/Stream.html dojo/topic dijit/_Templated dijit/_Widget ic-ee/bean/PermissionsBean ic-incontext/util/dom ic-incontext/util/html ic-incontext/util/misc ic-incontext/util/text ic-incontext/util/uri".split(" "),function(p,h,w,t,x,u,q,k,l,A,v,B,F,C,D,E,s,r,y,n,z){u("com.ibm.social.ee.widget.StreamPaging",null,{constructor:function(a){k.mixin(this,
a);this.pageSize||(this.pageSize=10);this.page||(this.page=1)},setTotal:function(a){this.total=a},setFetched:function(a){this.fetched=a},setHasNext:function(a){this.hasMore=a},setPage:function(a){this.page=a},setPageSize:function(a){var b=(this.page-1)*this.pageSize;this.pageSize=a;this.page=Math.floor(b/a)+1},hasNext:function(){return-1<this.total?this.page<this.getLastPage():this.hasMore},hasPrevious:function(){return 1<this.page},nextPage:function(){this.hasNext()&&this.page++;return this.getStartIndex()},
previousPage:function(){this.hasPrevious()&&this.page--;return this.getStartIndex()},getStartIndex:function(){return(this.page-1)*this.pageSize},getNextPage:function(){return this.hasNext()?this.page+1:-1},getPreviousPage:function(){return this.hasPrevious()?this.page-1:-1},getLastPage:function(){return 0<this.total?Math.ceil(this.total/this.pageSize):-1},isFullPage:function(){return 0<this.fetched&&this.fetched==this.pageSize},isPastEnd:function(){if(1<this.page){if(0===this.fetched)return!0;var a=
this.getLastPage();if(-1!=a&&this.page>a)return!0}return!1},detect:function(a,b,d){var c,g,f=-1,e=-1;a&&(c=z.parseUri(a),g=c.queryParameters,g.page?(f=n.parseInt(g.pageSize,10),e=(n.parseInt(g.page,1)-1)*f):g.sI?(f=n.parseInt(g.pageSize,-1),e=n.parseInt(g.sI,1)-1):f=n.parseInt(g.pageSize,-1));var h,m;"json"==d?(a=b.items?b.items.length:0,d=-1,"number"==typeof b.totalItems?d=b.totalItems:"number"==typeof b.totalSize&&(d=b.totalSize),h=b.previousUrl,m=b.nextUrl):(a=b.getElementsByTagName("entry").length,
d=n.parseInt(s.getChildElementTextContentNS(b,"totalResults",s.OPENSEARCH_NAMESPACE),-1),h=s.getChildElementAttributeMatching(b,"link","rel","previous","href"),m=s.getChildElementAttributeMatching(b,"link","rel","next","href"));if(-1==e&&-1!=f&&h){var k=z.parseUri(h).queryParameters;k.page?e=n.parseInt(k.page,1)*f:k.sI&&(e=n.parseInt(k.sI,1)-1+f)}-1==e&&(e=0);this.items=a;b?(-1!=d?(this.mode="index",this.total=0===e&&a<f?a:d,this.startIndex=e,this.uri=c):0===e&&(this.mode="index",this.total=a<f?a:
-1,this.startIndex=0,this.uri=c),this.mode||(h||m?(this.mode="url",this.next=m,this.previous=h,this.total=this.startIndex=-1):(this.mode="index",this.total=a<f?e+a:-1,this.startIndex=e,this.uri=c)),this.mode||(this.mode="unpaged",this.startIndex=0,this.total=-1),this.hasMore=-1!=this.total&&this.startIndex+a<this.total||this.next||-1==this.total&&a==f,this.pastEnd=0===a&&(0<this.total||0<this.startIndex),-1==f?f=a:this.checkForMore&&0<f&&--f,this.size=f):(-1!=f?(this.checkForMore&&--f,this.mode="index",
this.startIndex=e,this.size=f,this.parameters=g):(this.mode="unpaged",this.startIndex=0,this.size=-1),this.total=-1,this.visible=0)}});u("com.ibm.social.ee.widget.StreamRenderer",null,{minimalPaging:!1,constructor:function(a){this.widgets=[];this.sorts=[];this.connections=[];this.itemState=[];k.mixin(this,a)},destroy:function(){this.cleanup()},cleanup:function(){y.destroy(this.widgets);this.widgets=[];this.itemState=[];w.forEach(this.connections,p.disconnect);this.connections=[]},render:function(a,
b,d){var c;for(this.updatePaging(a,b,d);a.actionConnections&&0<a.actionConnections.length;)a.actionConnections[a.actionConnections.length-1].remove(),a.actionConnections.pop();a.actionConnections||(a.actionConnections=[]);if(this.actions)for(c=0;c<this.actions.length;c++)this.actions[c].ondelete?a.actionConnections.push(l(this.actions[c],"delete",k.hitch(a,"refresh"))):this.actions[c].onfilechange?a.actionConnections.push(l(this.actions[c],"filechange",k.hitch(a,"onfilechange"))):this.actions[c].onsuccess?
a.actionConnections.push(l(this.actions[c],"success",k.hitch(a,"refresh"))):this.actions[c].onchangescene&&a.actionConnections.push(l(this.actions[c],"changescene",k.hitch(a.widget,a.widget.changeScene)));if(this.folderActions)for(c=0;c<this.folderActions.length;c++)this.folderActions[c].ondelete?a.actionConnections.push(l(this.folderActions[c],"delete",k.hitch(a,"refresh"))):this.folderActions[c].onfilechange?a.actionConnections.push(l(this.folderActions[c],"filechange",k.hitch(a,"onfilechange"))):
this.folderActions[c].onsuccess?a.actionConnections.push(l(this.folderActions[c],"success",k.hitch(a,"refresh"))):this.folderActions[c].onchangescene&&a.actionConnections.push(l(this.folderActions[c],"changescene",k.hitch(a.widget,a.widget.changeScene)));if(this.pageActions)for(c=0;c<this.pageActions.length;c++)this.pageActions[c].ondelete?a.actionConnections.push(l(this.pageActions[c],"delete",k.hitch(a,"refresh"))):this.pageActions[c].onfilechange?a.actionConnections.push(l(this.pageActions[c],
"filechange",k.hitch(a,"onfilechange"))):this.pageActions[c].onsuccess?a.actionConnections.push(l(this.pageActions[c],"success",k.hitch(a,"refresh"))):this.pageActions[c].onchangescene&&a.actionConnections.push(l(this.pageActions[c],"changescene",k.hitch(a.widget,a.widget.changeScene)));var g=d.json?d.json.items?d.json.items.length:0:d.items?d.items.length:0;d=d.json?d.json:d;if(0===g)this.renderEmpty(a,b,d);else for(r.removeChildren(b),this.sortingEnabled&&this.renderSorting(a,b,d),c=0;c<g;c++)d.items[c]._position=
c,this.itemState[c]=d.items[c],this.renderItem(a,b,d,d.items[c],c,0===c,c==g-1)},renderItems:function(a,b,d,c,g){for(var f=0;f<g;f++)this.renderItem(a,b,d,c[f],f,0===f,f==g-1)},getSortInfo:function(){var a=this.sortId,b=this.sortReversed,d=this.getSorts(a,b);if(d&&0<d.length){a=y.indexById(d,"id",a);if(!a){for(b=0;b<d.length;b++)if(d[b].isDefault){a=d[b];break}a||(a=d[0]);b=!1}return{list:d,active:a,reversed:b}}},renderSorting:function(a,b,d){var c=this.getSortInfo();if(c){d=c.list;var g=c.active,
c=c.reversed,f=q.doc;b=h.create("div",{className:"lotusSort"},b);b=h.create("ul",{className:"lotusInlinelist"},b);var e=h.create("li",{className:"lotusFirst"},b);e.appendChild(f.createTextNode(a._strings.SORT_BY));for(var k=0,m;m=d[k];k++){e=h.create("li",null,b);0===k&&(e.className="lotusFirst");e=h.create("a",{role:"button"},e);if(m==g){e.setAttribute("aria-pressed",!0);t.add(e,"lotusActiveSort");var l=m.lowToHigh?!c:c;t.add(e,l?"lotusAscending":"lotusDescending");e.setAttribute("aria-sort",l?"ascending":
"descending");l&&m.sortAscMsg?e.title=m.sortAscMsg:!l&&m.sortDescMsg&&(e.title=m.sortDescMsg)}else e.setAttribute("aria-pressed",!1),e.removeAttribute("aria-sort");this.generateSortLink(a,m,m!=g||c?!0:!1,e);e.appendChild(f.createTextNode(m.name))}}},renderItem:function(a,b,d,c,g,f,e){},renderError:function(a,b,d,c){this.updatePaging(a,b,{});"noFiles"!=c.type?(r.removeChildren(b),b=h.create("DIV",{className:"qkrError"},b),this.addRenderErrorMessage(b,a,c),a.hideLoading()):this.renderEmpty(a,b,d)},
addRenderErrorMessage:function(a,b,d){b=q.doc;d.type?a.appendChild(b.createTextNode(d.type+": "+d.message)):a.appendChild(b.createTextNode(d.message))},renderEmpty:function(a,b,d){var c=q.doc;r.removeChildren(b);this.renderTypes(a,b,d);b=h.create("DIV",{className:"qkrEmpty"},b);var g;a.msgNoData&&(g=a.msgNoData.SHARE.DEFAULT);b.appendChild(c.createTextNode(g||"Empty"))},renderTypes:function(a,b,d){d=q.doc;if(this.types){b=h.create("div",{className:"lotusSort"},b);b=h.create("ul",{className:"lotusInlinelist"},
b);var c=h.create("li",{className:"lotusFirst"},b);c.appendChild(d.createTextNode(a.typeLabel));for(var g=0,f;f=this.types[g];g++)c=h.create("li",null,b),0===g&&(c.className="lotusFirst"),c=h.create("a",null,c),f==this.activeType&&t.add(c,"lotusActiveSort"),this.generateLinkToTypes(a,f,c),c.appendChild(d.createTextNode(f.name))}},allowMultipleExpand:function(a){return!0},toggleItem:function(a,b,d){d&&(d.preventDefault(),d.stopPropagation());d=this.itemState[b];d._isExpanded?(this.collapseItem(a,a.data,
d,b),d._isExpanded=!1,this.allowMultipleExpand()||(a._expandItem=null)):(d._isRendered?(!this.allowMultipleExpand()&&a._expandItem&&(this.collapseItem(a,a.data,a._expandItem.item,a._expandItem._position),a._expandItem._isExpanded=!1,a._expandItem=null),this.expandItem(a,a.data,d,b)):(!this.allowMultipleExpand()&&a._expandItem&&(this.collapseItem(a,a.data,a._expandItem.item,a._expandItem._position),a._expandItem._isExpanded=!1,a._expandItem=null),this.renderItemExpand(a,a.data,d,b),d._isRendered=!0),
d._isExpanded=!0,this.allowMultipleExpand()||(a._expandItem=d))},updatePaging:function(a,b,d){b=q.doc;a.jumpPageNode&&this.destroyJumpTo(a.jumpPageNode);a.topPageNode&&(a.topPageNode.className="lotusPaging");a.bottomPageNode&&(a.bottomPageNode.className="lotusPaging");if((d=d.paging)&&0<d.fetched&&0!==d.pageSize&&(-1==d.total||d.fetched<d.total)){var c=d.hasPrevious(),g=d.hasNext();if(!this.minimalPaging||g||c){if(a.pageSizeListNode){var f=a.pageSizeListNode.getElementsByTagName("A");w.forEach(f,
function(b){b.parentNode.style.display="";b.value=n.parseInt(b.innerHTML,-1);x.byId(a.id+b.value.toString()).style.display="none"});for(var e=0;e<f.length;e++){var h=f[e];h.value==d.pageSize&&(h.parentNode.style.display="none",x.byId(a.id+h.value.toString()).style.display="")}}this._d(a.tPreviousLinkNode,c);this._d(a.bPreviousLinkNode,c);this._d(a.tPreviousTextNode,!c);this._d(a.bPreviousTextNode,!c);this._d(a.tNextLinkNode,g);this._d(a.bNextLinkNode,g);this._d(a.tNextTextNode,!g);this._d(a.bNextTextNode,
!g);this.minimalPaging&&(c=g||c?"":"none",this._s(a.topPageNode,c),this._s(a.bottomPageNode,c));this._s(a.topPageNavigateNode);this._s(a.bottomPageNavigateNode);this.createPageCount(b,a,a.pageInfoNode,d);-1!=d.total?(c=d.page,g=d.getLastPage(),this.createPageList(b,a,a.pageListNode,c,g),this.createJumpTo(b,a,a.jumpPageNode,c,g)):this._h(a.pageListNode);this._d(a.pageSizeListNode,-1!=d.pageSize)}else this._h(a.topPageNode),this._h(a.bottomPageNode)}else this.minimalPaging&&(this._h(a.topPageNode),
this._h(a.bottomPageNode)),this._h(a.topPageNavigateNode),this._h(a.bottomPageNavigateNode),this._h(a.pageSizeListNode),this._h(a.pageInfoNode),this._h(a.pageListNode)},_d:function(a,b){a&&(a.style.display=b?"":"none")},_h:function(a){a&&(a.style.display="none")},_s:function(a,b){a&&(a.style.display=b||"")},hidePaging:function(a){this._h(a.topPageNavigateNode);this._h(a.bottomPageNavigateNode);this._h(a.pageSizeListNode);this._h(a.pageInfoNode);this._h(a.pageListNode)},createPageCount:function(a,
b,d,c){if(d){var g=c.pageSize*(c.page-1),f=g+1,g=c.fetched+g;-1!=c.total&&(g=Math.min(g,c.total));c=-1!=c.total||c.hasNext()?-1!=c.total?p.number.format(c.total):"??":g;h.empty(d);"??"==c?d.appendChild(a.createTextNode(v.substitute(b._strings.COUNT_SHORT,[p.number.format(f),p.number.format(g)]))):d.appendChild(a.createTextNode(v.substitute(b._strings.COUNT,[p.number.format(f),p.number.format(g),c])));d.style.display=""}},createJumpTo:function(a,b,d,c,g){if(d)if(1<g){var f=h.create("label",null,d),
e=dijit.getUniqueId("qkrLW_label");f.setAttribute("for",e);f.appendChild(a.createTextNode(b._strings.JUMP_TO_PAGE));c=h.create("input",{type:"text",value:c,id:e},d);c.setAttribute("autocomplete","OFF");d.appendChild(a.createTextNode(v.substitute(b._strings.OF_PAGES,[p.number.format(g)])));d.style.display="";a=l(c,"change",k.hitch(null,function(a,b,c){c&&13==c.keyCode&&a.page(b.value)},b,c));this.connections.push(a)}else d.style.display="none"},destroyJumpTo:function(a){r.removeChildren(a)},createPageList:function(a,
b,d,c,g){if(d){h.empty(d);d.style.display="none";var f=h.create("li",{className:"lotusFirst"},d);f.appendChild(a.createTextNode(b._strings.PAGE));if(1<g){for(var f=!1,e=1;e<=g;e++){var k=Math.abs(c-e);3>=k?(this.createSpecificPageLinks(a,b,d,e,e,c),f=!1):1==e?(this.createSpecificPageLinks(a,b,d,e,e,c),f=!1):e==g?(this.createSpecificPageLinks(a,b,d,e,e,c),f=!1):f||(e+1==g?(this.createSpecificPageLinks(a,b,d,e,e,c),f=!1):1==e-1&&4>=k?(this.createSpecificPageLinks(a,b,d,e,e,c),f=!1):(f=h.create("li",
null,d),f.appendChild(a.createTextNode(b._strings.ELLIPSIS)),f=!0))}d.style.display=""}else d.style.display="none"}},createSpecificPageLinks:function(a,b,d,c,g,f){for(;c<=g;c++){var e=h.create("li",null,d);1==c&&(e.className="lotusFirst");c!=f?(e=h.create("a",null,e),this.generatePagingLink(b,c,e),e.appendChild(a.createTextNode(c))):h.create("span",null,e).appendChild(a.createTextNode(p.number.format(c)))}},getSorts:function(a,b){return this.sorts},changeSort:function(a,b,d){this.sortReversed=!d;
this.sortId=b;a.refresh()},generateSortLink:function(a,b,d,c){c.href="javascript:;";a=l(c,"click",k.hitch(this,this.changeSort,a,b.id,d));this.connections.push(a)},generatePagingLink:function(a,b,d){d.href="javascript:;";a=l(d,"click",k.hitch(a,a.page,b));this.connections.push(a)}});return u("com.ibm.social.ee.widget.Stream",[D,C],{templateString:B,view:"summary",baseClass:"",renderer:new com.ibm.social.ee.widget.StreamRenderer,msgNoData:null,_strings:null,postMixInProperties:function(){this.oldWidget&&
(this.data={dataStore:this.oldWidget.dataStore,paging:this.oldWidget.paging},delete this.oldWidget);this.renderer&&(this._initPageStyle=this.renderer.minimalPaging?"display: none":"",this._loadingImg=require.toUrl("ic-ee/images/loading.gif"),this.renderer.templatePath&&(this.templatePath=this.renderer.templatePath),this.renderer.templateString&&(this.templateString=this.renderer.templateString))},postCreate:function(){this.msgNoData=this.msgNoData||this._strings.EMPTY;this.inherited(arguments);if(this.pageSizeListNode)for(var a=
this.pageSizeListNode.getElementsByTagName("A"),b=0;b<a.length;b++){var d=a[b],c=n.parseInt(d.innerHTML,-1);-1!=c&&this.own(l(d,"click",k.hitch(this,this.setPageSize,c)))}a={};this.pageSize&&(a.pageSize=this.pageSize);this.startPage&&(a.page=this.startPage);this.data||(this.data={dataStore:this.dataStore,paging:new com.ibm.social.ee.widget.StreamPaging(a)})},getDataStore:function(){return this.dataStore},setDataStore:function(a){this.data.dataStore=this.dataStore=a;a={};this.pageSize&&(a.pageSize=
this.pageSize);this.data.paging=new com.ibm.social.ee.widget.StreamPaging(a)},destroy:function(){this.renderer&&(this.renderer.destroy(),this.renderer=null);this.inherited(arguments)},setPageSize:function(a,b){b&&(b.preventDefault(),b.stopPropagation());this.pageSize=a;this.preferences&&this.preferences.put("itemsPerPage",a);this.data.paging.setPageSize(a);this.refresh()},page:function(a,b){b&&(b.preventDefault(),b.stopPropagation());if(1>a||a!=parseInt(a))a=1;this.clearError();/^-?\d+$/.test(a)?
(a>this.data.paging.getLastPage()&&(a=this.data.paging.getLastPage()),this.data.paging.setPage(a),this.refresh()):this.setError(this._strings.ERROR_INVALID_PAGE)},setError:function(a){var b=q.doc;this.errorNode&&(this.errorNode.appendChild(b.createTextNode(a)),this.errorNode.style.display="")},clearError:function(){this.errorNode&&(r.removeChildren(this.errorNode),this.errorNode.style.display="none")},next:function(a){a&&(a.preventDefault(),a.stopPropagation());this.data.paging.nextPage();this.refresh()},
previous:function(a){a&&(a.preventDefault(),a.stopPropagation());this.data.paging.previousPage();this.refresh()},onfilechange:function(a,b){this.renderer.highlightItems={};a&&b&&(this.renderer.highlightItems[a.getValue(b,"id")]=!0);this.refresh()},refresh:function(){this.clearError();var a={scope:this,onBegin:this._dataBegin,onComplete:this._dataComplete,onError:this._dataError,start:this.data.paging.getStartIndex(),count:this.data.paging.pageSize},b=this.renderer.getSortInfo();if(b&&b.active){var d=
b.active.sK,c=!b.active.lowToHigh;b.reversed&&(c=!c);a.sort=[{attribute:d,descending:c}]}this.data.dataStore.fetch(a);this.toggleNode.style.display=""},showLoading:function(){this.loadingIndicator&&(this.loadingIndicator.style.display="");h.empty(this.streamNode);this.renderer.hidePaging(this)},hideLoading:function(){this.loadingIndicator&&(this.loadingIndicator.style.display="none")},_dataBegin:function(a,b){this.data.paging.setTotal(a);-1==a&&b.hasNext&&this.data.paging.setHasNext(b.hasNext())},
_dataComplete:function(a,b){this.permissions=new E({owner:!1,authenticatedId:this.authUser});this.renderer.permissions=this.permissions;this.data.paging.setFetched(a.length);this.data.items=a;b.getFeedItem&&(this.data.feedItem=b.getFeedItem());this.data.paging.isPastEnd()?this.handlePastLastPage():(0<a.length?this.renderer.render(this,this.streamNode,this.data):(this.renderer.updatePaging(this,this.streamNode,this.data),this.renderer.renderEmpty(this,this.streamNode,this.data)),this.onUpdate(this.data))},
_dataError:function(a,b){this.data.paging.setFetched(0);this.renderer.renderError(this,this.streamNode,this.data,a);if("noFiles"!=a.type)this.onError(a)},handlePastLastPage:function(){if(this.data.paging.isPastEnd()){var a=this.data.paging.getLastPage();-1==a&&(a=1);this.data.paging.setPage(a);this.refresh();return!0}return!1},onUpdate:function(a){},onError:function(a){},update:function(a){if(a&&!a.paging&&(a.xml||a.json)&&(a.paging=this.getPaging(),a.xml?a.paging.detect(a.url,a.xml):a.json&&a.paging.detect(a.url,
a.json,"json"),this.handlePastLastPage(a.paging)))return;0<arguments.length&&(this.data=a);this.data?this.data.error?"undefined"!=typeof this.data.error.message?this._updateWithError(this.data.error):this._updateWithError({type:"unknown",message:this._strings.ERROR}):(this.data.xml?this.renderer.render(this,this.streamNode,this.data):this.data.json?this.renderer.render(this,this.streamNode,this.data):this.renderer.renderEmpty(this,this.streamNode,this.data),this.onUpdate(this.data)):this._loadFromUrl(this.url)},
updateItem:function(a,b){this.renderer.updateItem(this,this.data,this.streamNode,a,b)},_updateWithError:function(a){this.data={fromUrl:!0,error:a};this.renderer.renderError(this,this.streamNode,this.data,a)},_loadFromUrl:function(a){if(a&&""!==a){this.req&&!this.req.ioArgs._finished&&this.req.cancel();var b=this.handleAs||"xml";this.handleAsXsl&&(b="text");this.req=A(a,{method:"GET",handleAs:b,timeout:1E3*this.timeoutRetrieve,handle:k.hitch(this,this._loadFromUrlComplete)})}else this._updateWithError({message:"No URL specified",
type:"noUrl"})},getPaging:function(){return new com.ibm.social.ee.widget.StreamPaging({checkForMore:this.checkForMore})},resetData:function(){this.data&&(delete this.data.xml,delete this.data.json)}})});
