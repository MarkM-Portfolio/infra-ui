/* Copyright IBM Corp. 2015  All Rights Reserved.                    */
define("dojo dojo/on dojo/_base/declare dojo/_base/lang dojo/DeferredList dojo/_base/array dojo/topic dojo/dom-style dojo/dom-attr dojo/_base/window dojo/dom-construct dojo/dom dojo/i18n!ic-as/nls/activitystream dojo/i18n!ic-ee/nls/socialEEStrings dojo/json dojo/query dojo/string ic-ee/bean/Bean ic-ee/data/FilesRoutes ic-core/auth ic-as/util/hashtag/HashtagUtil ic-as/config/enablement ic-ee/bean/AtomBean com/ibm/lconn/layout/people ic-ee/gadget/_CommentsMixin ic-ee/gadget/_ActionsToolbarMixin ic-ee/data/SURecommendationsDataStore ic-ee/data/QCSFeedDataStore ic-ee/gadget/_SimpleTabsMixin ic-ee/gadget/_PreviewVideoMixin ic-ee/gadget/_HistoryMixin ic-ee/gadget/_GadgetMessageMixin ic-ee/gadget/_PreviewImageMixin ic-ee/gadget/_RecommendationsMixin ic-ee/gadget/_SimpleEEGadget ic-ee/gadget/_TagsMixin ic-ee/util/misc ic-eeconfig/config ic-incontext/util/text ic-incontext/util/url ic-incontext/widget/MessageContainer".split(" "),
function(q,r,H,f,I,J,u,s,K,m,k,g,L,U,t,z,v,M,N,A,O,B,P,Q,V,W,C,R,X,Y,Z,$,aa,ba,ca,da,D,E,n,S,T){(function(){var l=com.ibm.social.ee.gadget;H("com.ibm.social.ee.gadget.StatusUpdate",[l._SimpleEEGadget,l._HistoryMixin,l._PreviewImageMixin,l._PreviewVideoMixin,l._UrlPreviewMixin,l._CommentsMixin,l._RecommendationsMixin,l._TagsMixin,l._SimpleTabsMixin,l._GadgetMessageMixin,l._ActionsToolbarMixin],{actionsToolbar:null,DEFAULT_MAX_LENGTH:250,nlsAs:L,initializeUI:function(){this.inherited(arguments);this.initProfileImage();
this.initStatus();this.setButtonActions();this.initActionsToolbar();this.initializeRecommendations();this.initTabContainer();this.initializeHistoryTab();this.initializeComments();this.initAttachment();this.initVideoPreview();this.initUrlPreview()},getActionsToolbarNode:function(){return g.byId(this.prefix+"_actionLinks")},getTabContainerId:function(){return this.prefix+"_su-ee-tablist"},getTabStylePrefix:function(){return"su-ee"},getTabInitializers:function(a){return{history:"initializeHistory"}},
getCommentOpts:function(){return{commentCount:this.data.totalComments,url:this.data.commentsFeedUrl,dsConstructor:"com.ibm.social.ee.data.SUCommentsDataStore",dsOpts:{items:this.data.comments,totalItems:this.data.totalComments,authUser:this.data.authUser,permissionsUrl:this.routes.getSUPermissionsUrl()},createdStrings:this.nls.COMMENT_CREATED_NOVERSION,docTitle:"(none)",htmlComments:!0,allowNewComments:this.data.canComment,commentLikes:E.commentLikes,mentionsEnabled:E.mentionsEnabled,mentionsOpts:this.getMentionsOpts(),
likeDsFactory:this.getCommentLikeDsFactory(),likeOpts:this.getCommentLikeOpts(),useDeleteIcon:!0}},getMentionsOpts:function(){return{communityId:this.context.communityid?D.getItemId(this.context.communityid):null,isPublic:this.data["public"]}},getCommentsTabLinkId:function(){return this.prefix+"_commentsLink"},getCommentsContainer:function(){return g.byId(this.prefix+"_comments")},getCommentLikeDsFactory:function(){function a(a,b,c){f.mixin(a,{url:c.getValue(b,"likesFeed"),recommendCount:c.getValue(b,
"totalRecommendations"),hasRecommended:c.getValue(b,"hasRecommended"),retrievedRecommend:!0})}var c={net:this.network,authUser:f.clone(this.authUser)};return{getInlineDs:function(d,b){var e=f.mixin({countOnly:!0},c);a(e,d,b);return new C(e)},getPopupDs:function(d,b){var e=f.mixin({},c);a(e,d,b);return new C(e)}}},getCommentLikeOpts:function(){var a=this.getProfilesRoutes(),c=this.data.canComment,a={getUserProfileUrl:f.hitch(a,a.getUserProfileUrl),getUserPhotoUrl:f.hitch(a,a.getUserPhotoUrl)};c||f.mixin(a,
{currentUserId:""});return a},getRecommendInlineDSClass:function(){return"com.ibm.social.ee.data.SURecommendationsDataStore"},getRecommendPopupDSClass:function(){return this.getRecommendInlineDSClass()},getRecommendElement:function(){return g.byId(this.prefix+"_recommendation")},getRecommendDSOptions:function(){return{url:this.data.recommendationsFeed,recommendCount:this.data.totalRecommendations,hasRecommended:this.data.hasRecommended,retrievedRecommend:!0}},getRecommendOptions:function(){return this.data.canLike?
{}:{currentUserId:""}},getMissingErrorNode:function(){return g.byId(this.prefix+"_msgNode")},getMissingErrorMessage:function(){return this.nls.statusUpdate.error_404},onMissingItem:function(){u.publish("com/ibm/social/ee/event/scrollTop","")},getHistoryTab:function(){return g.byId(this.prefix+"_historyTab")},getHistoryContainer:function(){return g.byId(this.prefix+"_history")},getId:function(){return this.data.id},initializeComments:function(){this.inherited(arguments);var a=this.commentsWidget;a.setFixedMaxLength(this.DEFAULT_MAX_LENGTH);
"maxCommentLength"in this.data&&a.setFixedMaxLength(this.data.maxCommentLength)},initStatus:function(){var a=new O,c=this.data.tags||[],d=this.context.communityid?D.getItemId(this.context.communityid):null,b=g.byId(this.prefix+"_status");b.innerHTML=a.linkifyHashtags(this.data.message,c,d);z("a",b).attr("target","_blank");n.breakStringHTML(b,15)},initProfileImage:function(){var a;f.getObject("com.ibm.lconn.layout.people.createImage")?(a=Q.createImage(this.data.author,60,!0),k.place(a,g.byId(this.prefix+
"_userPhotoLink"),"replace"),K.set(a,"target","_blank"),q.removeAttr(a,"aria-describedby")):(g.byId(this.prefix+"_profileImage").src=this.getProfilesRoutes().getUserPhotoUrl(this.data.author.id),a=g.byId(this.prefix+"_userPhotoLink"));a.title=v.substitute(this.nls.file.profile_title,{user:this.data.author.name});a.setAttribute("aria-label",v.substitute(this.nls.file.profile_a11y,{user:this.data.author.name}))},setButtonActions:function(){var a=this,c=this.context,d=this.nls,b=[];this.data.canComment&&
b.push({name:this.nlsAs.commentText,title:d.COMMENTS.ADD_COMMENT_TOOLTIP,isVisible:function(){return!0},execute:f.hitch(a,function(){this.commentsWidget&&(this.switchTab("comments"),this.commentsWidget.createComment())})});!this.routes.anonymous&&this.context.eventId&&b.push({name:d.repost.name,title:d.repost.title,isVisible:function(){return a.data["public"]?!0:!1},execute:function(){var b=t.stringify({verb:"bump",id:c.eventId}),e=new com.ibm.social.ee.data.OpenSocialRoutes(a.getRouteOptions());
a.network.postJson({url:e.getRepostUrl(),postData:b,handleAs:"json",requireData:!0,headers:{"Content-Type":"application/json; charset=utf-8"},handle:f.hitch(a,function(b){var c=k.create("div"),e={refId:null,canClose:!0,message:c,onRemove:f.hitch(a,function(){s.set(g.byId(this.prefix+"_msgNode"),"display","none")})};b instanceof Error?(e.error=!0,c.appendChild(m.doc.createTextNode(d.repost.msg_generic))):(e.success=!0,c.appendChild(m.doc.createTextNode(d.repost.msg_success)));this.messageContainer?
(this.messageContainer.clear(),this.messageContainer.add(e,!0)):(this.messageContainer=new T({items:[e],nls:d.MESSAGE},g.byId(this.prefix+"_msgNode").appendChild(m.doc.createElement("div"))),this.messageContainer.onDisplayChange(),r(this.messageContainer,"DisplayChange",f.hitch(this,"onSizeChange")));s.set(g.byId(this.prefix+"_msgNode"),"display","");this.onSizeChange();u.publish("com/ibm/social/ee/event/scrollTop","")})})}});var e=g.byId(this.prefix+"_actionLinks");J.forEach(b,f.hitch(this,function(a){if(a.isVisible()){var b=
k.create("a",{href:"javascript:;",title:a.title,role:"button"},k.create("li",{},e));b.appendChild(m.doc.createTextNode(a.name));r(b,"click",f.hitch(a,"execute"))}}))},initAttachment:function(){if(this.data.ref&&this.data.ref.id){var a=this.getAttachmentId(this.data);this.getAttachmentDetails(a,f.hitch(this,this.attachmentEntryLoaded))}},getAttachmentId:function(a){var c=a.ref.id,d;a.ref.url?(d=/document\/(.*)\/media/,(a=d.exec(a.ref.url))&&a.length&&(c=a[1])):a.ref.imageUrl&&(d=/document\/(.*)\/thumbnail/,
(a=d.exec(a.ref.imageUrl))&&a.length&&(c=a[1]));return c},initUrlPreview:function(){if(this.data.ref&&"link"===this.data.ref.type){var a=g.byId(this.prefix+"_urlPreview");this.createUrlPreviewNode(a)}},initVideoPreview:function(){if(this.isVideoPlayable()&&this.previewEnabled()){var a=null,c=g.byId(this.prefix+"_urlPreview"),d=g.byId(this.prefix+"_attachmentMeta"),b=this.data.ref?this.data.ref.url:"";this.data.ref&&this.data.ref.author&&(a=this.data.ref.author,a=A.getUser()&&A.getUser().isExternal?
a.name:(new (f.getObject("com.ibm.social.as.util.ItemUtil"))).createNewsUser(a.id,a.name));this.data.ref&&this.data.ref.displayName&&this.initPreviewVideo(c,this.data.ref.displayName,b,b,a);k.place(c,d,"before");c.style.display=""}},isVideoPlayable:function(){if(this.data.ref&&this.data.ref.displayName){var a=n.getExtension(this.data.ref.displayName);return"mp4"===a||"mov"===a}return!1},previewEnabled:function(){return B.checkEnablement(B.AS_VIDEO_PREVIEW)},getAttachmentDetails:function(a,c,d){var b=
this.fileEntryUrl=S.rewrite(this.getFilesRoutes().getEntryUrl(a),{includeTags:!0,rendition:"mediumview"});a=new R({net:this.network});var e=new M;e.ds={isDirty:!1,isDeleted:!1,isNew:!1,attributes:{}};e.getUrlEntry=function(){return b};a.loadItem({item:e,onItem:f.hitch(this,c,a),onError:f.hitch(this,d)},{})},attachmentEntryLoaded:function(a,c){var d=g.byId(this.prefix+"_attachmentTitle"),b=k.create("h1",{className:"lotusHeading"},d),e=a.getValue(c,"urlDownload");!this.routes.anonymous&&this.routes.oauth&&
(e=e.replace("/anonymous/","/"),e=this.network.rewriteUrl(e));var l=a.getValue(c,"urlRendition"),w=a.getValue(c,"id"),F=a.getValue(c,"size"),G=a.getValue(c,"tags"),p=n.formatSize(F),s=v.substitute(this.nls.file.download.TOOLTIP,{size:p}),x=a.getValue(c,"name"),h=n.getExtension(x);k.create("img",{src:q.config.blankGif,className:"lconn-ftype16 lconn-ftype16-"+h,"aria-hidden":!0,role:"presentation",alt:""},b);this.addSharedExternallyWidget(d);h=k.create("a",{dir:"ltr",href:e,title:this.nls.file.download.DOWNLOAD_ALT},
b);n.breakString(x,m.doc,h);d.style.display="";if(l){var t=g.byId(this.prefix+"_imgPrev");this.getPreviewImageLink=function(){return this.network.rewriteUrl(l)};this.getPreviewImageNode=function(){return t};this.getPreviewImageData=function(){return{size:F,downloadTooltip:this.nls.file.download_tooltip,downloadLink:e}};this.initializePreviewImage()}d=g.byId(this.prefix+"_attachmentMeta");b=k.create("ul",{className:"lotusInlinelist lotusMeta"},d);this.data.ref.imageUrl?(h=k.create("li",{className:"lotusFirst"},
b),w=this.routes.getStatusUpdateEEPreviewUrl(this.context.id,this.getFilesRoutes().getImagePreviewLink(w,x,this.data["public"],!0),this.data["public"]),h=k.create("a",{target:"_blank",href:w,title:this.nls.file.PREVIEW.TITLE,id:this.prefix+"_previewLink"},h),h.appendChild(m.doc.createTextNode(this.nls.file.PREVIEW.LINK)),r(h,"click",f.hitch(this,"navigateToUrl",!0,h.href,this.checkExists)),h=k.create("li",{},b)):h=k.create("li",{className:"lotusFirst"},b);h=k.create("a",{href:e,title:s,id:this.prefix+
"_downloadLink"},h);h.appendChild(m.doc.createTextNode(this.nls.file.download.DOWNLOAD_ALT));r(h,"click",f.hitch(this,"navigateToUrl",!1,h.href,this.checkExists));h=k.create("li",{},b);k.create("span",{},h).appendChild(m.doc.createTextNode(p));if(0<G.length){var p=m.doc,h=k.create("li",{},b),y=k.create("span",{role:"list"},h);y.appendChild(p.createTextNode(this.nls.file.TAGS));y.appendChild(p.createTextNode(" "));this.getTags=function(){return G};this.getTagsNode=function(){return y};this.initializeTags()}d.style.display=
"";u.publish("com/ibm/social/ee/data/loaded","");this.onSizeChange()},getEntryUrl:function(){return this.routes.getStatusUpdateEEUrl(this.context.id,1)},checkExists:function(a,c){var d=new q.Deferred,b={handleAs:"text",url:a.getEntryUrl(),preventCache:!0,load:f.hitch(this,function(a){var b=null;z("textarea.data",this.domNode).forEach(function(a){b=t.parse(a.value)});b?d.callback():d.errback()}),error:function(){d.errback()}},e=new q.Deferred,g={handleAs:"xml",url:a.fileEntryUrl,preventCache:!0,load:f.hitch(this,
function(a){a=new P(a.documentElement);e.callback(a)}),error:function(){e.errback()}};a.network.get(b);a.network.get(g);b=new I([d,e]);b.addCallback(function(a){!0===a[0][0]&&!0===a[1][0]?c(a[1][1]):!0===a[0][0]&&!1===a[1][0]?c(null,!0):c(null)});b.addErrback(function(a){c(null)})},getFilesRoutes:function(){this.filesRoutes||(this.filesRoutes=new N(this.getRouteOptions()));return this.filesRoutes},getPrefix:function(){return this.prefix}})})();return StatusUpdate});
