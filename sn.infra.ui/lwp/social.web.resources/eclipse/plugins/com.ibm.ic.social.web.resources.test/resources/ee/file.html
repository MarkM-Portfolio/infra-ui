<html>
<!-- Copyright IBM Corp. 2011, 2015  All Rights Reserved.              -->
<body><p>${head}
</p><title>File EE Test</title>
${script:lconn.core.config.services}
${script:com.ibm.social.ee.test.util.serviceutil}
${script:com.ibm.social.incontext.util.dom}
${script:com.ibm.social.incontext.util.html}
${script:com.ibm.lconn.gadget.container.iContainer2}
${script:net.jazz.ajax.xdloader}
${script:dojo.cookie}

<script>
(function () {
   var util = com.ibm.social.ee.test.util.serviceutil;
   var lookup = com.ibm.social.ee.test.util.personlookup;
   var isSecure = util.isSecure();
   var filesCfg = lconn.core.config.services.files;
   var webResources = lconn.core.config.services.webresources;
   var webResUrl = (isSecure) ? webResources.secureUrl : webResources.url;
   var filesUrl = (isSecure) ? filesCfg.secureUrl : filesCfg.url;
   var personalFiles = null;
   var sharedWithMe = null;
   var publicFiles = null;
   var util2 = com.ibm.social.incontext.util;
   dojo.config.blankGif = "${_blankGif}";
   var iContainer = null;
   var inlineWidget = null;
   var gadgetHandle = null;
   var startTime = 0;
   var endTime = 0;
   var loadTime = 0;
   
   window.preloadGadget = function() {
   	  if(!iContainer) {
		   iContainer = com.ibm.lconn.gadget.container.iContainer2;
		   iContainer.init();
	  }
     iContainer.getCommonContainer().then(function(_container) {   	  
   	  _container.preloadGadget(webResUrl + "/web/com.ibm.social.ee/ConnectionsEE.xml"); 
     });
	   
   }
   
   window.startLoadTimer = function() {
      startTime = (new Date().getTime());
   }
   
   window.endLoadTimer = function() {
   	  endTime = (new Date().getTime());
   	  loadTime = endTime - startTime;
   	  dojo.byId("loadTime").innerHTML = "Load time: " + loadTime + "ms";
   }
  
 
   window.viewFileEEiFrame = function(atomId) {
      var fileId = atomId.substring(atomId.indexOf("!")+1);
      window.location.href = filesUrl + "/basic/api/document/" + fileId + "/embedded?type=standalone&width=380"; 
   }
   
   function resetInlineWidget() {
	   if (inlineWidget) {
		   inlineWidget.destroy();
		   inlineWidget = null;
		   var container = dojo.byId("inlineFiles");
		   dojo.empty(container);
		   dojo.create("center", { innerHTML: "Inline gadget goes here" }, container);
	   }
   }
   
   function resetGadget() {
	   if (gadgetHandle) {
		   gadgetHandle.close();
		   gadgetHandle = null;
		   var container = dojo.byId("iFrameFiles");
         dojo.empty(container);
         dojo.create("center", { innerHTML: "iFrame gadget goes here" }, container);		   
	   }
   }

   function parseParams() {
      var p = { }, params = window.location.search.substring(1).split("&"), i, parts;
      for (i = 0; i < params.length; i++) { parts = params[i].split("="); p[parts[0]] = decodeURIComponent(parts[1]); }
      return p;
   }
   
   function addNotificationParams(context) {
      var params = parseParams();
      if(params.notification && params.notification === "true") {
         dojo.mixin(context, {"notification.content": "test message provided during sharing action",
            actor: {connections: {state: "active"}, displayName: "Amadou Alain", 
               id: "urn:lsid:lconn.ibm.com:profiles.person:81e18b48-1378-4850-b758-7212d0f6f479",
               objectType: "person"}});
      }   
   }

   window.viewFileEEInline = function(atomId) {
      resetInlineWidget();
      resetGadget();
	  startLoadTimer();
      var fileId = atomId.substring(atomId.indexOf("!")+1);
	   net.jazz.ajax.xdloader.batch_load_async(["com.ibm.social.ee.widget.FileLoader", "com.ibm.social.incontext.NetworkDojo"], function () {
		   var clz = dojo.getObject("com.ibm.social.ee.widget.FileLoader");
		   var container = dojo.byId("inlineFiles");
		   dojo.empty(container);
		   var div = dojo.create("div", { }, container);
		   var context = { id: fileId };
		   addNotificationParams(context);
		   inlineWidget = new clz({ isGadget: false, context: context }, div);
		   dojo.connect(inlineWidget, "onLoaded", null, endLoadTimer); 
	   });      
   }
   window.viewFileEEGadgetiFrame = function(atomId) {
      resetInlineWidget();
      resetGadget();
      startLoadTimer();
	   if(!iContainer) {
		   iContainer = com.ibm.lconn.gadget.container.iContainer2;
		   iContainer.init();
	   }
	   var fileId = atomId.substring(atomId.indexOf("!")+1);
      var context = {
          "id": fileId,
          "eventType": "files.file.created",
          "onLoadedBody" : "window.parent.endLoadTimer()"
      };
      addNotificationParams(context);
      var container = dojo.byId("iFrameFiles");
      dojo.empty(container);
      var oauthEnabled = "false";
      if (dojo.cookie("_oauthEnabled") === "true") {
         oauthEnabled = "true";
      }      
      var gadgetUrl = webResUrl + "/web/com.ibm.social.ee/ConnectionsEE.xml";
      if (!oauthEnabled)
         gadgetUrl += ("?preventCache=" + (new Date()).getTime());
      var def = {
         definitionUrl: gadgetUrl,
         placement: "iFrameFiles",
         componentType: "gadget",
         instanceData: {
        	   renderType: "default",
        	   renderParams: { userPrefs: { "debug": "true" }  },
        	   eeDataModel: {
        		   context: context
        	   },
               viewParams: {
                  useOAuth: oauthEnabled
               }
         }
      };
      gadgetHandle = iContainer.loadWidget(def);
   }
   
   dojo.addOnLoad(function () {
      var currentUser = null;
      util.getXml(filesUrl + "/basic/cmis/my/servicedoc", function (svcdoc) {      
         // Get the current user
         currentUser = util.evalXPathString(svcdoc, "//app:workspace/atom:title/text()");
         if (currentUser) {
            dojo.place("<strong>" + currentUser + "", dojo.byId("currentUser"));
         }
                  
         var node = util.evalXPath(svcdoc, "//app:workspace/app:collection/cmisra:collectionType[text()='root']")[0];
         var rootFeed = node.parentNode.attributes.getNamedItem("href").value;
         if (rootFeed) {            
            util.getXml(rootFeed, function (feed){
               var node = util.evalXPath(feed, "/atom:feed/atom:entry/cmisra:pathSegment[text()='files']")[0];
               personalFiles = util2.dom.getChildElementAttributeMatchingNS(node.parentNode, "link", util2.dom.ATOM_NAMESPACE, "rel", null, "down", "href");               
               if (personalFiles) {
                  util.applyXsl(personalFiles, "file/files.xsl", dojo.byId("myFilesList"));
               }
               else {
                  alert("Could not get personal files feed");
               }
            });
         }
         else {
            alert("Could not get root feed");
         }
         var node = util.evalXPath(svcdoc, "//app:workspace/app:collection/cmisra:collectionType[text()='query']")[0];
         var queryFeed = node.parentNode.attributes.getNamedItem("href").value;
         if (queryFeed) {
            util.getXml(queryFeed, function (feed) {
               var node = util.evalXPath(feed, "/atom:feed/atom:entry/cmisra:pathSegment[text()='.filessharedwith']")[0];
               sharedWithMe = util2.dom.getChildElementAttributeMatchingNS(node.parentNode, "link", util2.dom.ATOM_NAMESPACE, "rel", null, "down", "href");               
               if (sharedWithMe) {
                  util.applyXsl(sharedWithMe, "file/files.xsl", dojo.byId("sharedWithMeList"));
               }
               else {
                  alert("Could not get feed for files shared with me");
               }
               
               var node = util.evalXPath(feed, "/atom:feed/atom:entry/cmisra:pathSegment[text()='.filespublic']")[0];
               publicFiles = util2.dom.getChildElementAttributeMatchingNS(node.parentNode, "link", util2.dom.ATOM_NAMESPACE, "rel", null, "down", "href");
               if (publicFiles) {
                  util.applyXsl(publicFiles, "file/files.xsl", dojo.byId("publicFilesList"));
               }
               else {
                  alert("Could not get feed for public files");
               }
            });
         }         
      }); 
      
      if (!currentUser) {
        util.applyXsl(filesUrl + "/form/anonymous/api/documents/feed?visibility=public", "file/files.xsl", dojo.byId("publicFilesList")); 
      }        
   });
})();

</script>
${endhead}

<div style="min-height:0px">
<div class="lotusContent" style="width: 1200px; height: 2000px;">
<table>
<tbody>
<tr>
<td width="500" style="vertical-align:top;">
<div style="overflow: hidden; width: 500px;">
<h1>EE File Test Page</h1>
<p style="width: 500px; word-wrap: break-word;">Current user: <span id="currentUser"></span></p>
<p style="height:20px"></p>
<div><button class="lotusButton" onclick="preloadGadget()">Preload Gadget</button></div>
<div style="margin-top:20px;margin-bottom:20px"><h2 id="loadTime"></h2></div>
<h3>My Files</h3>
<div id="myFilesList"></div>
<p></p>
<h3>Shared With Me</h3>
<div id="sharedWithMeList"></div>
<p></p>
<p></p>
<h3>Public Files</h3>
<div id="publicFilesList"></div>
</div>
</td>
<td width="500" style="vertical-align:top;">
<div id="inlineFiles" style="width:380px; margin-left:50px;border-style:solid;border-width:1px;border-color:#aaa;padding:20px">
<center>Inline gadget goes here</center>
</div>
<div id="iFrameFiles" style="width:380px; margin-left:50px;border-style:solid;border-width:1px;border-color:#aaa;padding:20px;margin-top:10px">
<center>iFrame gadget goes here</center>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div></body><p>
${end}</p></html>
