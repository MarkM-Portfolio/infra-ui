/* Copyright IBM Corp. 2015  All Rights Reserved.                    */
define("dojo dojo/_base/array dojo/_base/lang dojo/_base/window dojo/dom-construct dojo/_base/declare dojo/dom-attr dojo/aspect dojo/date/stamp dojo/dom-class dojo/fx/easing dojo/i18n!ic-ee/nls/socialEEStrings dojo/i18n!ic-core/lcTextArea/widgets/nls/ExpandingTextBox dojo/i18n!ic-as/nls/activitystream dojo/html dojo/has dojo/fx dojo/i18n!ic-ublog/nls/Mentions dojo/i18n!ic-ublog/nls/MentionsExtra dojo/on dojo/query dojo/string dojo/text!ic-ee/widget/templates/Comments.html dojo/topic dijit/_Widget dijit/_Templated dojox/html/entities ic-ee/util/ContentManipulation ic-as/util/hashtag/HashTagParser ic-as/util/hashtag/HashtagUtil ic-as/item/comment/SharedExternallyComments ic-core/auth ic-incontext/widget/MessageContainer ic-core/ext/timeago/Timeago net/jazz/ajax/xdloader ic-core/util/text ic-core/globalization/bidiUtil ic-ee/util/validation ic-ee/data/ShowMoreDataStore ic-ee/data/ProfilesRoutes ic-ee/bean/PermissionsBean ic-ee/action/FlagItem ic-ee/config ic-ee/widget/Recommendation ic-ee/widget/TextArea ic-incontext/util/DateFormat ic-incontext/util/atom ic-incontext/util/html ic-incontext/util/text ic-incontext/util/uri ic-news/microblogging/sharebox/data/MentionsDataFormatter".split(" "),
function(z,C,m,u,d,O,P,x,Q,n,R,D,ka,S,T,A,U,la,ma,p,g,J,V,w,W,X,E,Y,Z,$,aa,L,F,ba,ca,da,M,na,ea,fa,ga,ha,G,ia,N,oa,pa,H,qa,ra,ja){(function(){var s=com.ibm.social.incontext.util;new fa;O("com.ibm.social.ee.widget.Comments",[W,X],{templateString:V,commentIdParam:"commentId",commentsLength:51200,mimeType:"text/plain",postModerationEnabled:!1,authUser:null,fileOwner:null,showVersion:!0,commentCount:0,currVersion:1,defaultPageSize:50,initialPageSize:5,startIndex:0,isDraft:!1,loading:null,_moreDs:null,
allowNewComments:!0,category:"comment",commentModified:!1,textAreaConnection:null,_asStrings:S,_strings:D.COMMENTS,_stringsMsg:D.MESSAGE,_stringsSubmitted:D.COMMENTS_SUBMITTED,_stringsCommon:D.common,_stringsFile:D.file,htmlComments:!1,linkifyComment:!1,linkifyMentions:!1,plainTextMentions:!1,htmlEncoded:!1,SHORT_COMMENT_LENGTH:255,countAvailable:!0,commentLikes:!1,mentionsEnabled:!1,userIconSize:32,mentionsDataFormatter:null,useDeleteIcon:!1,isExternal:!1,escapeHTMLBeforePosting:!1,hashTagParser:new Z,
hashtagUtil:new $,sendDocTitle:!0,postMixInProperties:function(){this.inherited(arguments);var a=m.getObject(this.dsConstructor),c=this.dsOpts||{};c.url=s.uri.rewriteUri(this.url,{});c.net=this.net;a={ds:new a(c),dateAttr:"published",idAttr:"id",countAvailable:this.countAvailable};this._moreDs=new ea(a);this.htmlComments&&(this.mimeType="html")},postCreate:function(){this._showLoading();this.inherited(arguments);this.permissions=new ga({owner:!1,authenticatedId:this.authUser});var a=this;this.own(x.after(this,
"handleCreate","onDisplayChange",!0));this.own(x.after(this,"handleEdit","onDisplayChange",!0));this.own(x.after(this,"updateItem","onDisplayChange",!0));this.own(x.after(this,"hideActions","onDisplayChange",!0));this.own(x.after(this,"showActions","onDisplayChange",!0));this.own(x.after(this,"_showCommentsUI","onDisplayChange",!0));this.own(x.after(this,"showInlineCommentError","onDisplayChange",!0));this.own(x.after(this,"removeInlineCommentError","onDisplayChange",!0));this.own(x.after(this,"_getCommentItems",
"onDisplayChange",!0));this.own(p(this,"CommentsDisplayed","onDisplayChange"));this.isExternal&&(this.sharedExternallyComments=new aa({toShow:!1},this.sharedExternallyComments));this.textAreaDfd=new z.Deferred;this._getCommentItems(!0);0===this.commentCount&&this._showEmptyMsg();var c;if(this.mentionsEnabled){var b=this;c={textAreaOpts:{baseClass:"lotusText eeTextArea",name:"description"},shadowText:this._strings.PLACEHOLDER_TXT,id:this.id+"addCommentBody",mentionsEnabled:this.mentionsEnabled,mentionsOpts:this.mentionsOpts,
network:this.net,onFocus:function(){b.isExternal&&b.sharedExternallyComments.show();a.textAreaConnection||(a.textAreaConnection=a.connect(this,"onHeightChanged","scrollToBottom"));a.actionBtns.style.top="0";this.onHeightChanged()},disablePostAction:m.hitch(this,function(){this.disableSubmit(this.addCommentNode)}),enablePostAction:m.hitch(this,function(){this.enableSubmit(this.addCommentNode)}),mentionsWarningPlaceholder:this.atMentionsMessages};m.mixin(c,{reachedCharLimitCallback:m.hitch(this,function(a){a?
this.disableSubmit(this.addCommentNode):this.enableSubmit(this.addCommentNode)}),charRemainingDisplay:this.commentCountdownContainer});var f=this.textCtnr.parentNode;n.remove(f,"lotusFieldEmphasis");H.showLoading(this.textCtnr);ca.load_async("com.ibm.social.ee.widget.MentionsTextArea",m.hitch(this,function(){this.newCmtTxtArea=new com.ibm.social.ee.widget.MentionsTextArea(c,this.textCtnr);n.add(f,"lotusFieldEmphasis");var a=g("textarea",this.newCmtTxtArea.domNode)[0];a&&(a.style.overflowX="hidden");
this.own(p(this.newCmtTxtArea,"Change","checkIfModified"));this.own(p(this.newCmtTxtArea,"HeightChanged","onDisplayChange"));M.enforceTextDirectionOnPage(this.addCommentNode);this.newCmtTxtArea.startup();this.textAreaDfd.callback();this.newCmtTxtArea.turnOffAriaLiveRegion();this.mentionsDataFormatter=new ja(this.plainTextMentions)}))}else{c={value:this._strings.PLACEHOLDER_TXT,id:this.id+"addCommentBody"};this.newCmtTxtArea=new N(c,this.textCtnr);this.own(p(this.newCmtTxtArea,"Focus","textAreaFocused"));
this.own(p(this.newCmtTxtArea,"Change","checkIfModified"));this.own(p(this.newCmtTxtArea,"HeightChanged","onDisplayChange"));this.own(p(this.newCmtTxtArea,"Blur","onDisplayChange"));var d=g("textarea",this.newCmtTxtArea.domNode)[0];d&&n.add(d,"bidiAware");this.textAreaDfd.callback()}},textAreaFocused:function(){this.isExternal&&this.sharedExternallyComments.show();this.textAreaConnection||(this.textAreaConnection=this.own(p(this.newCmtTxtArea,"HeightChanged","scrollToBottom")));""===this.newCmtTxtArea.getText()&&
(this.actionBtns.style.top="0");this.onDisplayChange()},checkIfModified:function(){window.setTimeout(m.hitch(this,function(){this.commentModified===(""===this.newCmtTxtArea.getText())&&this._updateListener(!this.commentModified);A("ie")&&!this.mentionsEnabled&&(this.onDisplayChange(),this.scrollToBottom())}),0)},setFixedMaxLength:function(a){this.textAreaDfd.addCallback(m.hitch(this,function(){this.newCmtTxtArea.maxLength=a}))},_updateListener:function(a){this.commentModified=a;w.publish("com/ibm/social/ee/event/modified",
{modified:a})},_getCommentItems:function(a,c){this._moreDs.fetch({start:this.startIndex,count:this._getFetchCount(a),query:{uuid:this.uuid},sort:[{attribute:"published",descending:!0}],onComplete:m.hitch(this,function(b,f){c&&c();this.authUser.id&&this.allowNewComments&&!this.isDraft&&(this.cmtList.style.display="",this.addCommentCtnr.style.display="");b&&0<b.length?this._showCommentsUI(b,f.hasMore,a):this._doNothing();this.onDisplayChange()}),onError:m.hitch(this,function(b,f){c&&c();this._showPagingErrorMsg(a,
b)})})},_getFetchCount:function(a){return a?this.initialPageSize:this.defaultPageSize},_linkifyCommentForHashtags:function(a){a.communityId=this.params.mentionsOpts?this.params.mentionsOpts.communityId:null;a.contents?a.contents=this.hashtagUtil.linkifyHashtags(a.contents,a.tags,a.communityId):(a.tags=this.hashTagParser.getTagsArray(a.tags),a.content=this.hashtagUtil.linkifyHashtags(a.content,a.tags,a.communityId));return a},_getCommentAriaLabelSameDay:function(){return this._asStrings.commentAriaLabelSameDay},
_getCommentAriaLabelOtherDay:function(){return this._asStrings.commentAriaLabel},_getCommentAriaLabel:function(a){return a?this._getCommentAriaLabelSameDay():this._getCommentAriaLabelOtherDay()},_createCommentUItem:function(a,c,b,f,k){a=this._linkifyCommentForHashtags(a);var e,l,h,g=this,n=u.doc,q=this._moreDs,w=q.getValue(a,"permissions").Delete,x=q.getValue(a,"permissions").Edit,C=this.authUser&&q.getValue(a,"author").id===this.authUser.id,D=this.authUser&&this.fileOwner&&this.fileOwner.id===this.authUser.id,
I=q.getValue(a,"deleted"),r=q.getValue(a,"moderationStatus");h=null;r&&(r=r.toLowerCase());l=this.cmtList;c||(c=d.create("li",{className:"lotusCommentItem",role:"article",tabindex:"0"},l));var v=d.create("div",{className:"lotusPost eeComment"},c),t=d.create("a",{className:"lotusHidden"},v);t.name=t.id="comment-"+q.getValue(a,"id");l=q.getValue(a,"author");var y;if("quarantined"===r&&!q.getValue(a,"stateChangedBy")&&this._strings.MODERATION_QUARANTINED)t=d.create("div",null,v),l=d.create("span",{className:"lotusMeta"},
t),l.appendChild(n.createTextNode(this._strings.MODERATION_QUARANTINED));else if("rejected"!==r||this.displayRejectedStateChangedBy())if(t=d.create("div",{className:"lotusPostAuthorInfo"},v),e=d.create("div",{className:"lotusPostAvatar"},t),t=null,"pending"===r)this.generateUserImage&&this.generateUserImage(l,e,this.userIconSize,this.userIconSize,null,{imagePop:!1,title:this._strings.PROFILE_TITLE,generateLink:!1}),t=d.create("div",null,v),l=d.create("span",{className:"lotusMeta"},t),l.appendChild(n.createTextNode(this._strings.MODERATION_PENDING));
else if("quarantined"===r||"rejected"===r)this.generateUserImage&&this.generateUserImage(l,e,this.userIconSize,this.userIconSize,null,{imagePop:!1,title:this._strings.PROFILE_TITLE,generateLink:!1}),t=d.create("div",null,v),l=d.create("span",{className:"lotusMeta"},t),e=new s.DateFormat(q.getValue(a,"stateChangedDate")),e=e.formatByAge("quarantined"===r?this._strings.MODERATION_REMOVED:this._strings.MODERATION_REJECTED),s.html.substitute(n,l,e,{user:function(){var b=q.getValue(a,"stateChangedBy"),
c=n.createElement("span");c.appendChild(n.createTextNode(b.name));g.generateLinkToPerson&&g.generateLinkToPerson(b,c);return c},timestamp:function(){return n.createTextNode((new s.DateFormat(q.getValue(a,"stateChangedDate"))).formatByAge(g._strings.COMMENT_CREATED_TIME))}});else{this.generateUserImage&&this.generateUserImage(l,e,this.userIconSize,this.userIconSize,null,{imagePop:!1,title:this._strings.PROFILE_TITLE,generateLink:!1});h=dijit.getUniqueId("eeComment");t=d.create("div",{className:"lotusPostContent"},
v);y=d.create("div",{className:"lotusMeta",id:h},t);if(I)this.showTitles&&(h=d.create("h4",null,y),h.appendChild(n.createTextNode(q.getValue(a,"title")))),l=d.create("span",{},y),h=(new s.DateFormat(q.getValue(a,"updated"))).formatByAge(this._strings.COMMENT_DELETED),s.html.substitute(n,l,h,{user:function(){var b=q.getValue(a,"modifier"),c=n.createElement("span");c.appendChild(n.createTextNode(b.name));g.generateLinkToPerson&&g.generateLinkToPerson(b,c);return c}});else{this.showTitles&&(h=d.create("h4",
null,y),h.appendChild(n.createTextNode(q.getValue(a,"title"))));e=d.create("ul",{className:"lotusInlinelist"},y);h=d.create("li",{className:"lotusFirst"},e);h=d.create("span",{className:"vcard"},h);s.text.breakString(l.name,n,h);var B=L.getUser()&&L.getUser().isExternal;g.generateLinkToPerson&&!B&&g.generateLinkToPerson(l,h);h=d.create("li",{className:"lotusFirst"},e);e=!1;1<z.date.difference(q.getValue(a,"published"),q.getValue(a,"updated"),"second")&&(e=!0);B=this.showVersion&&parseInt(this.currVersion)!==
q.getValue(a,"versionLabel")?e?this._strings.COMMENT_EDITED:this._strings.COMMENT_CREATED:e?this._strings.COMMENT_EDITED_NOVERSION:this._strings.COMMENT_CREATED_TIME;e=e?q.getValue(a,"updated"):q.getValue(a,"published");var B=(new s.DateFormat(e)).formatByAge(B),A=(new s.DateFormat(e)).formatByAge(g._strings.COMMENT_CREATED_TIME),A={user:l.name,timestamp:A,version:q.getValue(a,"versionLabel")},B=J.substitute(B,A);h=d.create("abbr",{title:Q.toISOString(e),className:"timeNode"},h);T.set(h,B);(new ba({},
h)).domNode.title=B;h=(new s.DateFormat(e,{time:function(a,b){return z.date.locale.format(this.dt,{selector:"time",timePattern:"hh:mm:ss a",locale:djConfig.locale})}})).formatByAge(g._strings.COMMENT_CREATED_TIME);e=h.match(/^\d{1,2}:\d\d/);e=this._getCommentAriaLabel(e);l=J.substitute(e,[l.name,h]);c.setAttribute("aria-label",l)}this.commentMetaRendered(q,a,y,I);h=d.create("div",{className:"lotusPostDetails eeCommentContent"},t);l=q.getValue(a,"contents");h.commentBody=l;e=d.create("p",{},h);e.className=
"bidiAware";this.initAttachment(a,t);this.setCommentContent(I,h,e,l,q,a)}else t=this.addRejectedDivContentNoPersonRef(v);if(this.commentLikes&&this.likeDsFactory&&"quarantined"!==r&&"rejected"!==r&&"pending"!==r){var H=this,r=this.likeDsFactory.getInlineDs(a,q),K={currentUserId:this.authUser.id,dataStore:r,popupDataStore:this.likeDsFactory.getPopupDs(a,q),displayNameAttr:"name",userIdAttr:"id",mailAttr:"email",strings:{},_blankGif:z.config.blankGif,onSizeChange:function(a){H.onDisplayChange(a)},onErrorMessage:m.hitch(this,
this.onLikeError,a)};this.likeOpts&&m.mixin(K,this.likeOpts);var E=K.currentUserId?!1:!0;I&&(E=!0);var F,G=new z.Deferred;r.fetch({onBegin:function(a){F=a;G.callback()}});G.addCallback(function(){if(0<F||!E){var a;y.firstChild&&y.firstChild.tagName&&"ul"===y.firstChild.tagName.toLowerCase()?(a=d.create("li",{},y.firstChild),a=d.create("div",{className:"lotusCommentLike"},a)):a=d.create("div",{className:"lotusChunk lotusCommentLike"},y,"after");new ia(K,a)}})}this.useDeleteIcon&&w&&(r=d.create("a",
{className:"lotusDelete keepFocus",href:"javascript:;",title:this._strings.DELETE,alt:this._strings.DELETE},t),dijit.setWaiRole(r,"button"),dijit.setWaiState(r,"label",this._strings.DELETE),p(r,"focus",m.hitch(this,this._forceVisibleActions,v)),d.create("img",{src:z.config.blankGif,alt:""},r),d.create("span",{className:"lotusAltText",innerHTML:"X"},r),p(r,"click",m.hitch(this,m.hitch(this,this.deleteComment,a))));r=this._createActionsDiv(t);r.style.display="none";e=d.create("div",null,t);l=d.create("ul",
{className:"lotusInlinelist lotusActions"},r);a.element=v;this.own(p(v,"mouseenter",m.hitch(this,"_toggleEditBtns",v,!0)));this.own(p(v,"mouseleave",m.hitch(this,"_toggleEditBtns",v,!1)));this.renderActionLinks(q,r,l,n,a,h,t,x,w,C,D,I,e,c);l.hasChildNodes()?r.style.display="":d.empty(r);f||k||!b||(this.commentCount++,this.onCountChange(this.commentCount));this._placeCommentNode(c,b,f);p(v,"focus",m.hitch(this,this._forceVisibleActions,v));M.enforceTextDirectionOnPage(this.domNode);return c},onLikeError:function(a,
c,b,f){this.showInlineCommentError(a,f||this._stringsCommon.like_error)},displayRejectedStateChangedBy:function(){return!0},addRejectedDivContentNoPersonRef:function(a){return a},_createActionsDiv:function(a){return d.create("div",{className:"lotusPostMore"},a)},_placeCommentNode:function(a,c,b){c?d.place(a,this.sharedExternallyComments&&this.sharedExternallyComments.domNode?this.sharedExternallyComments.domNode:this.addCommentCtnr,"before"):b||(this.commentContainer?d.place(a,this.commentContainer,
"first"):(c=""===this.showMoreLink.style.display?this.showMoreLink:this.addCommentLink,d.place(a,c,"after")))},_focusNewCmt:function(){this._forceVisibleActions(this.addCmtNode)},_forceVisibleActions:function(a){var c=this,b=g("a",this.cmtList);C.forEach(b,function(a){n.contains(a,"keepFocus")||a.setAttribute("tabIndex","-1")});b=g("div.eeComment",this.cmtList);C.forEach(b,function(a){c._toggleEditBtns(a,!1)});b=g("a",a);C.forEach(b,function(b){b.setAttribute("tabIndex","0");c._toggleEditBtns(a,!0)})},
performLinkifyMentions:function(a){var c=this;a=d.create("div",{innerHTML:a});g(".vcard",a).forEach(function(a,f,k){k=g(".fn",a)[0];f=g(".x-lconn-userid",a)[0];if(k&&f){var e=k.innerHTML;k={};k.userid=f.innerHTML;k.name=e;e=d.create("div");c.generateLinkToPerson(k,e);k=g("a",e)[0];d.place(k,a,"after");f=m.clone(f);z.setStyle(f,"display","none");d.place(f,k,"after");d.destroy(a)}});return a.innerHTML},setCommentContent:function(a,c,b,f,d,e){a=u.doc;c=f;this.htmlEncoded&&(f=E.decode(f));this.plainTextMentions&&
(f=da.htmlify(f));this.linkifyMentions&&(f=this.performLinkifyMentions(f));this.htmlComments?(b.innerHTML=f,s.text.breakStringHTML(b),g("a",b).attr("target","_blank")):this.htmlCommentsSummary?this.setCommentContentSummary(c,b):this.linkifyComment?s.html.createTextNode(a,b,f):s.text.breakString(f,a,b)},setCommentContentSummary:function(a,c,b){a=Y.generate_summary(a,b||-1);d.empty(c);this.htmlEncoded&&(a=E.decode(a));this.linkifyMentions&&(a=this.performLinkifyMentions(a));c.innerHTML=a;s.text.breakStringHTML(c)},
_toggleEditBtns:function(a,c){c?n.add(a,"lotusPostHover"):n.remove(a,"lotusPostHover")},renderActionLinks:function(a,c,b,f,k,e,l,h,g,n,q,s,u){(a=a.getValue(k,"moderationStatus"))&&(a=a.toLowerCase());"pending"!==a&&"quarantined"!==a&&"rejected"!==a&&(s||(h&&(h=d.create("li",{className:"lotusFirst eeActionLinks"},b),h=d.create("a",{href:"javascript:;",title:this._strings.EDIT_TOOLTIP,role:"button",className:"editBtn"},h),this.own(p(h,"click",m.hitch(this,this.editComment,k))),h.appendChild(f.createTextNode(this._strings.EDIT)),
this.focusEdit&&(h.focus(),this.focusEdit=!1)),g&&!this.useDeleteIcon&&(g=b.firstChild,h=d.create("li",null,b),g||(h.className="lotusFirst eeActionLinks"),h=d.create("a",{href:"javascript:;",title:this._strings.DELETE_TOOLTIP,role:"button",className:"deleteBtn"},h),this.own(p(h,"click",m.hitch(this,this.deleteComment,k))),h.appendChild(f.createTextNode(this._strings.DELETE)))),this.permissions.authenticatedId&&this.postModerationEnabled&&(g=b.firstChild,h=d.create("li",null,b),g||(h.className="lotusFirst eeActionLinks"),
h=d.create("a",{href:"javascript:;",title:this._strings.FLAG_ITEM.COMMENT.TITLE,role:"button"},h),this.own(p(h,"click",m.hitch(this,this.flagComment,k,c,u))),h.appendChild(f.createTextNode(this._strings.FLAG_ITEM.ACTION)),c=dijit.getUniqueId("qkrLW_describe"),h.setAttribute("aria-label",this._strings.FLAG_ITEM.ACTION),h.setAttribute("aria-describedby",c),d.create("span",{className:"lotusAccess",id:c},h).appendChild(f.createTextNode(this._strings.FLAG_ITEM.COMMENT.A11Y))))},flagComment:function(a,
c,b){var f=u.doc.activeElement,d;this._clearMessages(a);c.style.display="none";b.style.display="";var e=this;d=new ha({rootNode:b,flagRefitemType:"Comment",net:this.net,scene:this,comment:a,previousLink:f});this.connect(d,"cancelAction",m.hitch(d,function(a,b){b.style.display="none";a.style.display="";d.gotoPreviousLink();e.onDisplayChange()},c,b));d.execute(a,a,d);this.onDisplayChange()},editComment:function(a,c){c&&(c.preventDefault(),c.stopPropagation());this._clearMessages(a);var b=a.element,
f=this._moreDs,k=u.doc,e=g("DIV._qkrEditSection",b)[0];e&&d.destroy(e);g(".lotusPostContent",b)[0].style.display="none";var e=d.create("div",{className:"lotusPostContent _qkrEditSectionWrapper"},b),b=d.create("div",{className:"lotusPostInlineActions _qkrEditSection"},e),b=d.create("form",{className:"lotusForm2 lotusStreamUpdate"},b),e=d.create("div",{className:"lotusFieldEmphasis"},b),e=d.create("div",{},e),l=f.getValue(a,"contents"),h=this,f={noPlaceholder:!0,baseClass:"lotusText eeTextArea",value:l,
name:"description",id:dijit.getUniqueId("commentBody"),ariaLabel:h._strings.COMMENT_LABEL},n=new N(f,e);n.setText(l);this.own(p(n,"Focus","onDisplayChange"));this.own(p(n,"Blur","onDisplayChange"));this.connect(n,"onChange",function(){h.commentModified===(n.getText()===l)&&h._updateListener(!h.commentModified)});p(n,"HeightChanged",m.hitch(this,"onDisplayChange"));a.taWidget=n;f=d.create("div",{className:"lotusActions"},b);f=d.create("ul",{className:"lotusInlinelist"},f);b=d.create("li",{className:"lotusFirst eeActionLinks"},
f);b=a.submitBtn=d.create("a",{className:"lotusAction submitEnabled",role:"button",href:"javascript:;"},b);d.create("strong",{},b).appendChild(k.createTextNode(this._strings.SAVE));this.own(p(b,"click",m.hitch(this,this.performEdit,a)));b=d.create("li",{},f);f=d.create("a",{className:"lotusAction",role:"button",href:"javascript:;"},b);this.own(p(f,"click",m.hitch(this,this.cancelEdit,a)));f.appendChild(k.createTextNode(this._strings.CANCEL));n.focus();this.onDisplayChange()},cancelEdit:function(a,
c){c&&(c.preventDefault(),c.stopPropagation());var b=a.element,f=g("DIV._qkrEditSectionWrapper",b)[0];f&&d.destroy(f);g(".lotusPostContent",b)[0].style.display="";this._clearMessages(a);this.onDisplayChange();(b=g(".lotusPostContent a.editBtn",b)[0])&&dijit.focus(b);this._updateListener(!1)},performEdit:function(a,c){c&&(c.preventDefault(),c.stopPropagation());if(n.contains(a.submitBtn,"submitEnabled")){var b=g("DIV._qkrEditSection > FORM",a.element)[0];this.disableSubmit(b);if(this.validateComment(b,
a,!0)){var b=a.taWidget.getText(),f=m.hitch(this,this.handleEdit,a),d=m.hitch(this,this.onEditError,a),e=this._moreDs,l=e.newItem({category:this.category});e.revert();e.setValue(l,"contents",b);e.setValue(l,"comment",b);e.setValue(l,"mimeType",this.mimeType);e.setValue(l,"urlEntry",e.getValue(a,"urlEntry"));e.setValue(l,"category",this.category);e.setValue(l,"doctype","comment");e.setValue(l,"atomId",e.getValue(a,"atomId"));e.setValue(l,"id",e.getValue(a,"id"));w.publish("com/ibm/social/ee/comment/beforeUpdate");
e.save({scope:this,onComplete:f,onError:d})}else this.enableSubmit(b)}},handleEdit:function(a,c,b){if(c&&!(c instanceof Error)){this.hideActions(a.element);this.cancelEdit(a);var f=m.hitch(this,this.updateItem,a);b=m.hitch(this,this.getItemError,a,c,b);this._moreDs.loadItem({item:a,onItem:f,onError:b,forceLoad:!0});this.confirmSubmission(c,m.hitch(this,function(a,b,c){this.permissions.authenticatedId&&this.postModerationEnabled&&this.updateItem(a,b);this.showActions(a.element);(a=g(".editBtn",a.element)[0])&&
!c?a.focus():g("a.lotusActiveSort",this.domNode)[0].focus()},a,c))}},updateItem:function(a,c){w.publish("com/ibm/social/ee/comment/updated",this._moreDs.getValue(c,"updated"));var b=a.element.parentNode;b.removeChild(a.element);this._createCommentUItem(c,b,!1,!0,!1);w.publish("com/ibm/social/ee/comment/afterUpdated");(b=g(".lotusPostContent a.editBtn",a.element)[0])&&dijit.focus(b)},getItemError:function(a,c,b,f){this.onEditError(a,f)},onEditError:function(a,c){var b,f;b=c.code;b="cancel"===b?this._strings.ERROR_EDIT_CANCEL:
"timeout"===b?this._strings.ERROR_EDIT_TIMEOUT:"ItemNotFound"===b?this._strings.ERROR_EDIT_NOT_FOUND:"AccessDenied"===b?this._strings.ERROR_EDIT_ACCESS_DENIED:"unauthenticated"===b?this._strings.ERROR_EDIT_NOT_LOGGED_IN:this._strings.ERROR_EDIT;f=g("DIV._qkrEditSection > FORM",a.element)[0];this.showInlineCommentError(a,b,null,f)},deleteComment:function(a,c){c&&(c.preventDefault(),c.stopPropagation());this._clearMessages(a);var b=a.element,f=g(".lotusPostContent",b)[0];this.hideActions(f);var k=g("div.comment-delete-prompt",
b)[0],e=null;k?(k.style.display="",e=g("a.submitEnabled",b)[0]):(k=d.create("div",{className:"lotusPostInlineActions comment-delete-prompt"},f,"first"),dijit.setWaiRole(k,"presentation"),e=d.create("form",{className:"lotusActionBox",role:"presentation"},k),d.create("span",{className:"lotusActionMessage delete-confirm",innerHTML:this._strings.DELETE_CONFIRM,"aria-live":"assertive",role:"alert"},e),e=d.create("div",{className:"lotusActions lotusClear",role:"presentation"},e),b=d.create("ul",{className:"lotusInlinelist",
role:"presentation"},e),k=d.create("li",{className:"lotusFirst",role:"presentation"},b),e=a.submitBtn=d.create("a",{className:"lotusAction submitEnabled",role:"button",href:"javascript:;"},k),e.appendChild(u.doc.createTextNode(this._strings.YES)),this.own(p(e,"click",m.hitch(this,this.doRemove,a))),n.add(e,"comments-refresh-btn"),k=d.create("li",{role:"presentation"},b),b=d.create("a",{className:"lotusAction cancel-button",role:"button",href:"javascript:;"},k),this.own(p(b,"click",m.hitch(this,this.cancelRemove,
a))),b.appendChild(u.doc.createTextNode(this._strings.CANCEL)));g(">.lotusMeta>.lotusInlinelist",f).style("display","none");dijit.focus(e);this.onDisplayChange()},cancelRemove:function(a,c){var b=a.element;this._clearMessages(a);g(".lotusPostContent div.comment-delete-prompt",b).style("display","none");g(".lotusPostContent > .lotusMeta > .lotusInlinelist",b).style("display","");this.showActions(b);(b=g(".lotusPostContent a.deleteBtn",b)[0])&&dijit.focus(b);this.onDisplayChange()},doRemove:function(a,
c){c&&(c.preventDefault(),c.stopPropagation());if(n.contains(a.submitBtn,"submitEnabled")){var b=g("div.comment-delete-prompt > form",a.element)[0];this.disableSubmit(b);this._clearMessages(a);var b=this._moreDs,f=m.hitch(this,this.handleRemove,a),d=m.hitch(this,this.onRemoveError,a),e=b.newItem({urlEntry:b.getValue(a,"urlEntry"),category:this.category});b.deleteItem(e);w.publish("com/ibm/social/ee/comment/beforeDelete");b.save({scope:this,onComplete:f,onError:d})}},handleRemove:function(a,c,b){if(!c||
c&&!(c instanceof Error)){w.publish("com/ibm/social/ee/comment/deleted");if(1<this.commentCount&&(c=a.element.parentNode.previousSibling,b=a.element.parentNode.nextSibling,c))try{var d=g("a.lotusPerson",c);0<d.length&&dijit.focus(d[0])}catch(k){b&&(d=g("a.lotusPerson",b),0<d.length&&dijit.focus(d[0]))}a.element.parentNode.parentNode.removeChild(a.element.parentNode);this.commentCount--;0===this.commentCount&&this.addCmtNode&&dijit.focus(this.addCmtNode);this.onCountChange(this.commentCount);0===this.commentCount&&
this._showEmptyMsg();this.onDisplayChange()}},onRemoveError:function(a,c){var b,d;b=c.code;b="cancel"===b?this._strings.ERROR_DELETE_CANCEL:"timeout"===b?this._strings.ERROR_DELETE_TIMEOUT:"ItemNotFound"===b?this._strings.ERROR_DELETE_NOT_FOUND:"AccessDenied"===b?this._strings.ERROR_DELETE_ACCESS_DENIED:"unauthenticated"===b?this._strings.ERROR_DELETE_NOT_LOGGED_IN:this._strings.ERROR_DELETE;d=g("div.comment-delete-prompt > form",a.element)[0];this.showInlineCommentError(a,b,null,d)},disableSubmit:function(a){g("a.submitEnabled",
a).forEach(function(a){a.setAttribute("aria-disabled",!0);n.add(a,"submitDisabled");n.remove(a,"submitEnabled");n.add(a,"lotusPersonInactive")})},enableSubmit:function(a){g("a.submitDisabled",a).forEach(function(a){a.setAttribute("aria-disabled",!1);n.add(a,"submitEnabled");n.remove(a,"submitDisabled");n.remove(a,"lotusPersonInactive")})},_showCommentsUI:function(a,c,b){var f=a.length;if(0<f){b?a=a.reverse():this.commentContainer=d.create("div",{style:{display:"none"}},""===this.showMoreLink.style.display?
this.showMoreLink:this.addCommentLink,"after");var k=this;C.forEach(a,function(a){k._createCommentUItem(a,null,b,!1,b)});this.empty.style.display="none";this.startIndex+=f;this.commentContainer&&U.wipeIn({node:this.commentContainer,duration:5>=f?250:15>=f?375:750,easing:R.quadInOut,onEnd:function(){k.commentContainer=null;k.onCommentsDisplayed()}}).play()}this.loading.style.display="none";this.showMoreLink.style.display=c?"":"none";this.cmtList.style.display="";this.onCommentsDisplayed()},onCommentsDisplayed:function(){this.updateCountText();
w.publish("com/ibm/social/ee/data/loaded")},_showEmptyMsg:function(){this.empty.style.display="";this.loading.style.display="none";this.addCommentLink.style.display="none";this.showMoreLink.style.display="none"},_doNothing:function(){this.loading.style.display="none"},_showPagingErrorMsg:function(a,c){var b=d.create("span"),f=u.doc,k=this;H.substitute(f,b,this.prevItem?this._strings.ERROR_ADDTL:this._strings.ERROR,{again:function(){var b=d.create("a");b.href="#";b.setAttribute("role","button");b.title=
k._strings.ERROR_AGAIN_TITLE;b.appendChild(f.createTextNode(k._strings.ERROR_AGAIN));k.connect(b,"onclick",m.hitch(k,k._tryAgain,a));return b}});this.addTopLevelErrorMessage(b,a);a&&(this.addCommentCtnr.style.display="none");this.loading.style.display="none";this.showMoreLink.style.display="none";this.onDisplayChange()},_tryAgain:function(a){this.loading.style.display="";this._clearMessages();this._getCommentItems(a)},scrollToBottom:function(a,c){c||window.setTimeout(function(){w.publish("com/ibm/social/ee/event/scrollBottom")},
50)},createComment:function(a){a&&(a.preventDefault(),a.stopPropagation());this.newCmt&&this._clearMessages(this.newCmt);this.onDisplayChange();a=m.hitch(this,function(){this.newCmtTxtArea.setFocus();this.scrollToNewComment()});setTimeout(a,100)},scrollToNewComment:function(){this.scrollToBottom()},cancelCreate:function(a){a&&(a.preventDefault(),a.stopPropagation());this._clearMessages(this.newCmt);this._resetText();this.onDisplayChange();dijit.focus(this.addCmtNode);this._updateListener(!1)},_getCommentsText:function(){return(this.mentionsEnabled?
this.mentionsDataFormatter.formatData(this.newCmtTxtArea.getTrackedMentions(),this.escapeHTMLBeforePosting):this.newCmtTxtArea.getText())||""},performCreate:function(a){a&&(a.preventDefault(),a.stopPropagation());if(n.contains(this.newCmtBtn,"submitEnabled"))if(this.disableSubmit(this.addCommentNode),this.addCommentNode.getElementsByTagName("textarea"),this.newCmt||(this.newCmt={element:this.addCommentCtnr,taWidget:this.newCmtTxtArea}),this.validateComment(this.addCommentNode,this.newCmt)){a=this._getCommentsText();
if(this.linkifyCreateComment){var c=d.create("span");s.html.createTextNode(u.doc,c,a);a=c.innerHTML;a=A("ie")||A("webkit")?a.replace(/<wbr>/gi,""):a.replace(/\u200B/gi,"")}this._handleDS(a)}else this.enableSubmit(this.addCommentNode)},_handleDS:function(a){var c=this._moreDs,b=c.newItem({category:this.category});c.setValue(b,"doctype","comment");c.setValue(b,"contents",a);c.setValue(b,"comment",a);c.setValue(b,"mimeType",this.mimeType);this.sendDocTitle&&c.setValue(b,"title",this.docTitle);this._doPerformCreate(c,
b)},_doPerformCreate:function(a,c){w.publish("com/ibm/social/ee/comment/beforeCreate");a.save({scope:this,onComplete:this.handleCreate,onError:this.onCreateError})},handleCreate:function(a,c){var b=!1,d;a instanceof Error?(this.enableSubmit(this.addCommentNode),this._resetText()):(w.publish("com/ibm/social/ee/comment/created",this._moreDs.getValue(a,"published")),this.cancelCreate(),this.empty.style.display="none",d=this._createCommentUItem(a,null,!0,!1,!1),w.publish("com/ibm/social/ee/comment/afterCreated"),
this.confirmSubmission(a),this.enableSubmit(this.addCommentNode),b=!0,this._updateListener(!1));if(A("ie")&&this.mentionsEnabled){var k=this.addCmtNode;window.setTimeout(function(){dijit.focus(k)},0)}else dijit.focus(this.addCmtNode);d&&(d=g("a",d),C.forEach(d,function(a){a.setAttribute("tabIndex","-1")}));b&&this.scrollToBottom()},confirmSubmission:function(a,c){if(a){var b=this._moreDs.getValue(a,"moderationStatus");b&&"pending"===b.toLowerCase()?(b=d.create("div"),b.appendChild(u.doc.createTextNode(this._stringsSubmitted.CONFIRM)),
this.addTopLevelSuccessMessage(b),c&&c(!0)):c&&c()}},onCreateError:function(a){a=a.code;this.showInlineCommentError(this.newCmt,"cancel"===a?this._strings.ERROR_CREATE_CANCEL:"timeout"===a?this._strings.ERROR_CREATE_TIMEOUT:"ItemNotFound"===a?this._strings.ERROR_CREATE_NOT_FOUND:"AccessDenied"===a?this._strings.ERROR_CREATE_ACCESS_DENIED:"unauthenticated"===a?this._strings.ERROR_CREATE_NOT_LOGGED_IN:"Unauthorized"===a?this._strings.ERROR_UNAUTHORIZED:this._strings.ERROR_CREATE,null,this.addCommentNode)},
addComment:function(a){this._createCommentUItem(a,null,!0,!1,!1)},_getMoreComments:function(){var a=this.showMoreLoadingNode;a.style.display="inline-block";this._getCommentItems(!1,function(){a.style.display="none"})},_clearMessages:function(a){this.messageContainer&&this.messageContainer.clear();this.messageLocation.style.display="none";a&&this.removeInlineCommentError(a)},hideActions:function(a){this.useDeleteIcon&&g("a.lotusDelete",a).style("display","none");g("div.lotusPostMore",a).style("display",
"none")},showActions:function(a){this.useDeleteIcon&&g("a.lotusDelete",a).style("display","");g(".lotusPostContent div.lotusPostMore",a).style("display","")},addTopLevelSuccessMessage:function(a,c,b){if(this.messageLocation){this.messageLocation.style.display="";this.messageJustAdded=!0;var d=u.doc;a={success:!0,refId:c,canClose:!0,message:a,onRemove:b};this.messageContainer?this.messageContainer.add(a,!0):(this.messageContainer=new F({items:[a],nls:this._stringsMsg},this.messageLocation.appendChild(d.createElement("div"))),
this.messageContainer.onDisplayChange(),p(this.messageContainer,"DisplayChange",m.hitch(this,"onDisplayChange")))}},addTopLevelErrorMessage:function(a,c,b,f){if(this.messageLocation){this.messageJustAdded=!0;var k=u.doc;c?(d.empty(this.messageLocation),d.create("div",{className:"lconnEmpty",role:"alert"},this.messageLocation).appendChild(a)):(a={error:!0,refId:b,canClose:!0,message:a,onRemove:f},this.messageContainer?this.messageContainer.add(a,!0):(d.empty(this.messageLocation),this.messageContainer=
new F({items:[a],nls:this._stringsMsg},this.messageLocation.appendChild(k.createElement("div"))),this.messageContainer.onDisplayChange(),p(this.messageContainer,"DisplayChange",m.hitch(this,"onDisplayChange"))));this.messageLocation.style.display="";this.messageLocation.focus()}},_resetText:function(){this.actionBtns.style.top="-9999px";this.newCmtTxtArea.resetBox()},_showLoading:function(){H.showLoading(this.loading);this.loading.style.display=""},validateComment:function(a,c,b){if(a){var d=c.taWidget.getText();
if(0===s.text.trim(d).length)return this.showInlineCommentError(c,b?this._strings.ERROR_NO_CONTENT_EDIT:this._strings.ERROR_NO_CONTENT,null,a),!1;if(d.length>G.common.maxCommentLength)return this.showInlineCommentError(c,null,"length",a),!1}else return this.showInlineCommentError(c,this._strings.ERROR_GENERAL),!1;this.removeInlineCommentError(c);return!0},trimField:function(a,c){var b=a.taWidget.getText(),d=s.text.getCharIndexForUtf8Index(b,G.common.maxCommentLength);-1!==d&&a.taWidget.setText(b.substring(0,
d));this.removeInlineCommentError(a);a.taWidget&&a.taWidget.textArea._onInput()},showInlineCommentError:function(a,c,b,f){var k=u.doc,e=null,l=null;if(!a.hasError){l=d.create("div",{className:"lotusMessage2",role:"alert",name:"errorMsg",tabindex:"0"});z._isBodyLtr()?l.style.paddingRight="25px":l.style.paddingLeft="25px";a.errNode=l;d.place(l,a.element,"first");n.add(a.element,"eeCommentError");e=d.create("img",{className:"lconnSprite lconnSprite-iconError16",src:this._blankGif,alt:this._stringsMsg.ERROR,
title:this._stringsMsg.ERROR},l);e.style.marginRight="10px";e=d.create("span",{},l);if(c)e.appendChild(k.createTextNode(c));else if("length"===b&&f){var h=this;s.html.substitute(k,e,this._strings.WARN_LONG_COMMENT,{shorten:function(){var b=d.create("a",{href:"javascript:;",className:"keepFocus"}),c=m.hitch(h,"trimField",a,f);h.connect(b,"onclick",c);b.appendChild(k.createTextNode(h._strings.TRIM_LONG_COMMENT));return b}})}c=d.create("a",{href:"javascript:;",className:"lotusDelete keepFocus",title:this._stringsMsg.DISMISS},
l);p(c,"click",m.hitch(this,"removeInlineCommentError",a));dijit.setWaiRole(c,"button");dijit.setWaiState(c,"hidden",!1);e=d.create("img",{src:this._blankGif,alt:this._stringsMsg.DISMISS,title:this._stringsMsg.DISMISS},c);dijit.setWaiRole(e,"presentation");e=d.create("span",{className:"lotusAltText"},c);e.appendChild(k.createTextNode("X"));a.hasError=!0;e=c}f&&this.enableSubmit(f);e?e.focus():l?l.focus():g(".lotusMessage2",a.element)[0].focus()},removeInlineCommentError:function(a){a.hasError&&a.errNode&&
(a.element.removeChild(a.errNode),a.hasError=!1,a.errNode=null,n.remove(a.element,"eeCommentError"))},updateCountText:function(){if(this.commentCountNode){var a=this._asStrings.commentsCounter,a=J.substitute(a,[this.startIndex,this.commentCount]);P.set(this.commentCountNode,"innerHTML",a)}},_copyFromAttachments:function(a){if(!a.ref&&a.attachments&&0<a.attachments.length){a.ref={id:null,url:null,displayName:null};var c=a.attachments[0];a.ref.url=c.url;a.ref.id=c.id;a.ref.displayName=c.displayName}},
initAttachment:function(a,c){a.ref||this._copyFromAttachments(a);if("undefined"!==typeof a.ref&&"undefined"!==typeof a.ref.url){var b=a.ref.url,f=a.ref.displayName,k="lconn-ftype32 lconn-ftype32-"+f.substring(f.lastIndexOf(".")+1).toLowerCase(),e=J.substitute(this._stringsFile.download_tooltip,{0:f}),g=d.create("div",{},c,"last");d.create("img",{src:z.config.blankGif,className:k,"aria-hidden":!0,role:"presentation",alt:""},g);k=d.create("a",{dir:"ltr",href:"#no",title:e},g);a.fileURL=b;a.domLink=
k;a.fileDetailsDiv=g;a.downloadLinkConnect=p(k,"click",m.hitch(this,"getCommentAttachmentDetails",a));k.appendChild(u.doc.createTextNode(f))}},getCommentAttachmentDetails:function(a){if(a.ref&&a.ref.id){var c=this.getAttachmentId(a,a.ref.id);this.getAttachmentDetails(c,m.hitch(this,this.downloadCommentAttachment,a),m.hitch(this,this.showDownloadCommentAttachmentError,a.fileDetailsDiv))}},downloadCommentAttachment:function(a,c,b){a.domLink.href=a.fileURL;a.downloadLinkConnect.remove();a.domLink.click()},
showDownloadCommentAttachmentError:function(a){d.empty(a);var c=d.create("div",{className:"lotusMessage2",role:"alert",tabindex:"0"},a);c.appendChild(u.doc.createTextNode(this._stringsFile.error_404));c=this.addXtoMessage(c);p(c,"click",m.hitch(this,function(){d.destroy(a)}))},getCommentCount:function(){return this.commentCount},onCountChange:function(a){this.commentCount=a;this.updateCountText()},generateLinkToPerson:function(){},generateLinkToComment:function(){},onDisplayChange:function(){},commentMetaRendered:function(a,
c,b){}})})();return Comments});
