/* Copyright IBM Corp. 2015  All Rights Reserved.                    */
define("dojo dojo/_base/lang dojo/_base/declare dojo/i18n dojo/dom-class dojo/_base/window dojo/i18n!ic-sharebox/nls/socialShareboxStrings dojo/dom-style dojo/dom-construct dojo/aspect dojo/_base/array dojo/on dojo/query dojo/request dojo/text!ic-sharebox/controls/templates/ShareboxDialog.html dojo/topic dijit/_Widget dijit/_WidgetsInTemplateMixin ic-incontext/widget/MessageContainer ic-incontext/util/dom ic-sharebox/_dialog_utils ic-core/DialogUtil ic-incontext/ConnectionManager ic-core/config/services ic-incontext/util/proxy com/ibm/lconn/gadget/container/iContainer2 ic-core/auth ic-sharebox/controls/GadgetContentPane ic-sharebox/controls/TabContainer ic-sharebox/data/ConfigDataStore ic-ui/controls/TabbedDialog net/jazz/ajax/xdloader".split(" "),
function(f,e,v,N,s,p,y,k,q,l,g,w,n,z,A,x,B,C,D,E,F,G,H,t,r,I,J,K,O,L,M,P){(function(){var c=com.ibm.social.sharebox.controls,u=com.ibm.social.incontext.util;c.PATH="container/sharebox";c.COMM_PATH="container/communitySharebox";c.GLOBAL="global";c.COMMUNITY="community";c.SELECTION_CONTEXT="com.ibm.social.sharebox.context";c._instance=null;c._ctxInstance=null;c._actionsPreloaded=!1;c._dataMap={};c.getShareboxInstance=function(a){return a.type==c.GLOBAL?(c._instance||(c._instance=new com.ibm.social.sharebox.controls._ShareboxDialog({context:a})),
c._instance):a.type==c.COMMUNITY?(c._ctxInstance||(c._ctxInstance=new com.ibm.social.sharebox.controls._ShareboxDialog({context:a})),c._ctxInstance):null};c.clearShareboxInstance=function(a){a==c.GLOBAL?c._instance=null:a==c.COMMUNITY&&(c._ctxInstance=null)};c._connManager=null;c.getConnectionManager=function(){c._connManager||(c._connManager=new H);return c._connManager};v("com.ibm.social.sharebox.controls.ShareboxDialog",null,{_connManager:null,_dialog:null,_isOpen:!1,_ctx:null,constructor:function(a){var b=
this._connManager=com.ibm.social.sharebox.controls.getConnectionManager();this._ctx=a||{};this._ctx.type=this._ctx.type||c.GLOBAL;this._dialog=c.getShareboxInstance(this._ctx);b.cmconnect(this._ctx.type,this._dialog,"show",e.hitch(this,function(){this._isOpen=!0}));b.cmconnect(this._ctx.type,this._dialog,"hide",e.hitch(this,function(){this._isOpen=!1}))},open:function(){this._isOpen||this._dialog.openDialog()},close:function(){this._isOpen&&this._dialog.closeDialog()},isOpen:function(){return this._isOpen},
destroy:function(){this._dialog.closeDialog();c.clearShareboxInstance(this._ctx.type);this._connManager.clearConnScope(this._ctx.type);this._dialog.destroyRecursive()}});v("com.ibm.social.sharebox.controls._ShareboxDialog",[M,C],{templateString:A,widgetsInTemplate:!0,autofocus:!0,progress:null,_connManager:null,context:null,container:I,currentTab:null,validActionPath:null,actionTabs:null,submitInProgress:!1,_dialogUtils:null,blankIcon:B.prototype._blankGif,_initialOpen:!0,reloadActionsRequired:!1,
closeAttemptInProgress:!1,postMixInProperties:function(){this.nls=y;this.inherited(arguments);this.context.type==c.GLOBAL?this.validActionPath=c.PATH:this.context.type==c.COMMUNITY&&(this.validActionPath=c.COMM_PATH);this._dialogUtils=F.getInstance();this.actionTabs={}},buildRendering:function(){this.inherited(arguments);var a="https"===(window.location.protocol||"http").replace(":",""),b=t.news,b=(a?b.secureUrl:b.url)+"/sharebox/config.action",b=r(u.url.rewrite(b,{type:this.context.type}));this.configDs=
new L({url:b});b=t.opensocial;this.authenticatedUrl=r((a?b.secureUrl:b.url)+"/ic/rest/isAuthenticated");b=t.webresources;a=a?b.secureUrl:b.url;b=f.queryToObject(net.jazz.ajax.config.params).etag;this.loadingGifUrl=r(u.url.rewrite(a+"/web/com.ibm.lconn.core.styles.oneui3/images/loading.gif",{etag:b}));this.blankIcon=r(u.url.rewrite(this.blankIcon,{etag:b}));this.titleNode.appendChild(p.doc.createTextNode(this.context.type==c.COMMUNITY?this.nls.title.community:this.nls.title.global))},postCreate:function(){this.inherited(arguments);
f._isBodyLtr()||s.add(this.domNode,"dijitDialogRtl");this.container._initialized||(this.container.init(),this.container._initialized=!0);var a=this._connManager=com.ibm.social.sharebox.controls.getConnectionManager();this.connect=e.hitch(a,a.cmconnect,"sd"+this.id);this.own(l.after(this,"_position",e.hitch(this,"setPosition"),!0));this.hashSubscription=x.subscribe("/dojo/hashchange",e.hitch(this,this.clearPageMessages));this.own(l.after(this._dialogUtils,"close",e.hitch(this,this.closeDialog),!0));
this.own(l.after(this._dialogUtils,"shareAddActivityEntry",e.hitch(this,this.shareAddActvitiyEntry),!0));this.own(l.after(this._dialogUtils,"displayMessage",e.hitch(this,this.displayMessage),!0));this.own(l.after(this._dialogUtils,"displayMessageHtml",e.hitch(this,this.displayMessageHtml),!0));this.own(l.after(this._dialogUtils,"setDirty",e.hitch(this,this.setDirty),!0));this.own(l.after(this._dialogUtils,"setSubmitState",e.hitch(this,this.setSubmitState),!0));this.own(w(this,"CloseShareDialog",e.hitch(this._dialogUtils,
this._dialogUtils.onClose)));this.connect(this,"_openDialog",this._dialogUtils,e.hitch(this,function(){if(this.currentTab&&this.currentTab.gadgetNode)this._dialogUtils.onForceResize(this.currentTab.gadgetNode.id)}));this.loadActionsConfig()},loadActionsConfig:function(){this.configDs.fetch({scope:this,onComplete:function(a,b){var d=this;this.reloadActionsRequired=!1;this.container.getCommonContainer().then(function(b){d._registerHandlers(b);g.forEach(a,e.hitch(d,function(a){c._dataMap[a.url]={inline:a.inline,
parameters:a.parameters}}));var m=g.map(a,function(a){return a.url});b.preloadGadgets(m,e.hitch(d,d._loadTabs,m))})},onError:function(a,b){var d={message:this.nls.STATUS.ACTIONS_LOAD_ERROR,error:!0,canClose:!1};this.messageContainer?this._updateMessageContainer(this.messageContainer,d,this.messageBar):this.messageContainer=this._createMessageContainer(d,this.messageBar);this.reloadActionsRequired=!0}})},_confirmLogin:function(a){z(this.authenticatedUrl,{method:"GET",handleAs:"json",preventCache:!0}).then(a,
function(a,d){d&&d.xhr&&"401"==d.xhr.status&&J.login()})},_registerHandlers:function(a){a.actions.registerShowActionsHandler(e.hitch(this,this.handleShowAction));a.actions.registerHideActionsHandler(e.hitch(this,this.handleHideAction));this.container&&this.container.ICactions?this.container.ICactions.registerNavigateGadgetHandler(e.hitch(this,this.handleGadgetSelection)):a.actions.registerNavigateGadgetHandler(e.hitch(this,this.handleGadgetSelection))},_loadTabs:function(a,b){var d={},h=0,m=h=null,
f;for(f in b)if(b.hasOwnProperty(f)&&b[f].modulePrefs.features.actions&&(h=E.xmlDocumentFromString(b[f].modulePrefs.features.actions.params["action-contributions"]),m=h.getElementsByTagName("action"),0<m.length))for(d[f]=[],h=0;h<m.length;h++)m[h].getAttribute("path")==c.PATH&&d[f].push(m[h].getAttribute("id"));g.forEach(a,e.hitch(this,function(a,b){var d=a[b];d&&g.forEach(d,function(a){this._addTab(this.actionTabs[a],!this.tabs.hasChildren())},this)},d));this.tabs.hasChildren()||(d={message:this.nls.STATUS.ACTIONS_UNAVAILABLE,
error:!1,canClose:!1},this.messageContainer?this._updateMessageContainer(this.messageContainer,d,this.messageBar):this.messageContainer=this._createMessageContainer(d,this.messageBar))},_createMessageContainer:function(a,b){var d=new D({items:[a],nls:this.nls.MESSAGE},b.appendChild(p.doc.createElement("div")));k.set(b,"display","");return d},_updateMessageContainer:function(a,b,d){a&&(a.clear(),a.add(b,!0),k.set(d,"display",""))},clearPageMessages:function(){this.statusContainer&&this.statusContainer.clear();
this._hideMessageDiv()},_hideMessageDiv:function(a){a?k.set(a,"display","none"):0==n("div.lotusMain > div.lotusContent > div.shareStatus").style("display","none").length&&(a=g.filter(n("div.lotusMain > *"),function(a){if("none"!=k.get(a,"display"))return!0}),g.forEach(a,function(a){n("div.lotusContent",a).forEach("dojo.query('div.shareStatus',item).style('display','none');")}))},_addTab:function(a,b){this.tabs.addChild(a);b&&(this.currentTab=a,this.tabs.startup());this.tabs.updateOrientation(a);this.tabs.resize()},
handleShowAction:function(a){e.isArray(a)&&(a=a[0]);if(a&&this.validActionPath&&a.path==this.validActionPath){this.tabs.hasChildren();var b=new K({title:a.label,tooltip:a.tooltip,actionId:a.id,loadingGifUrl:this.loadingGifUrl,blankGifUrl:this.blankIcon},q.create("div"));this.own(w(b,"Show",e.hitch(this,this.showGadget,b)));this.actionTabs[a.id]=b}},handleHideAction:function(a){a&&a.id&&(a=g.filter(this.tabs.getChildren(),e.hitch(this,function(a,d){return d.actionId==a},a.id)),g.forEach(a,e.hitch(this,
function(a){this.tabs.removeChild(a)})),this.tabs.resize())},handleGadgetSelection:function(a,b){if(c._dataMap[a]){var d=this.currentTab,h;d.gadgetXmlUrl||(d.gadgetXmlUrl=a,h=e.mixin({},this.context),e.mixin(h,c._dataMap[a].parameters),d.createGadget(this.container,h,c._dataMap[a].inline),this._position(),this.setFocusController())}},setFocusController:function(){var a=document.activeElement.id;if(a)var a=dijit.byId(a),b=l.after(a,"_onBlur",function(a){"IFRAME"==document.activeElement.tagName&&(dijit.focus(this.focusNode),
b.remove())},!0)},showGadget:function(a){this.currentTab=a;var b=this;this.container.getCommonContainer().then(function(a){a.actions.runAction(b.currentTab.actionId,{type:"com.ibm.social.sharebox.context",dataObject:b.context})})},setPosition:function(){this.domNode.style.top="100px"},openDialog:function(){this._initialOpen?(this._openDialog(),this._initialOpen=!1):(this.reloadActionsRequired&&(k.set(this.messageBar,"display","none"),this.messageContainer&&this.messageContainer.clear()),this._confirmLogin(e.hitch(this,
function(){this._openDialog();this.reloadActionsRequired&&this.loadActionsConfig()})))},_openDialog:function(){s.add(p.body(),"lotusui30dojo_sharebox");this.clearPageMessages();this.currentTab&&this.showGadget(this.currentTab);this.show();this.setPosition();var a=f.marginBox(this.tabs.domNode).h+f.marginBox(this.messageBar).h,b=f.marginBox(this.tabs.domNode).w;f.marginBox(this.containerNode).h<a&&(f.marginBox(this.containerNode,{h:a,w:b}),k.set(this.containerNode,"height","auto"));k.set(this.domNode,
"display","")},closeDialog:function(){this._closeDialog()},_closeDialog:function(){if(!this.closeAttemptInProgress){this.closeAttemptInProgress=!0;var a=e.hitch(this,function(a){var b=this;window.setTimeout(function(){b.closeAttemptInProgress=!1},0);a&&this.cancelDialog()}),b;this.isDirty()?(b=this.currentTab.isDirty?f.string.substitute(this.nls.UNSAVEDCHANGES.CONFIRM_CURRENT_TAB,[this.currentTab.title]):this.nls.UNSAVEDCHANGES.CONFIRM_OTHER_TAB,G.prompt(this.nls.UNSAVEDCHANGES.DIALOG_TITLE,b,this.nls.UNSAVEDCHANGES.OK,
this.nls.UNSAVEDCHANGES.CANCEL,a,"lcShareboxConfirmDialog")):a(!0)}},cancelDialog:function(){this._cancelDialog(arguments)},_cancelDialog:function(){this.onCancel();this.onCloseShareDialog();setTimeout(e.hitch(this,function(){k.set(this.domNode,"display","none");s.remove(p.body(),"lotusui30dojo_sharebox")}),0)},onCloseShareDialog:function(){},destroy:function(){this._connManager.clearConnScope("sd"+this.id);this.hashSubscription&&this.hashSubscription.remove();this.inherited(arguments)},_onKey:function(a){a||
(a=window.event);if(a.keyCode==f.keys.ESCAPE&&a.target){var b=new f.NodeList(a.target);-1!=g.indexOf(b.parents(),this.domNode)&&(a.preventDefault(),a.stopPropagation(),this.closeDialog())}else this.inherited(arguments)},shareAddActvitiyEntry:function(a){a&&x.publish("com/ibm/social/as/event/addactivityentry",a)},displayMessage:function(a,b){b&&this._displayMessage(a,b)},displayMessageHtml:function(a,b){if(b){var d=q.create("span");d.innerHTML=b;this._displayMessage(a,d)}},_displayMessage:function(a,
b){var d,c,f=!1;if(b){if(d=n("div.lotusMain > div.lotusContent"),0==d.length&&(d=g.map(g.filter(n("div.lotusMain > *"),function(a){if("none"!=k.get(a,"display"))return!0}),function(a){return n("div.lotusContent",a)[0]}),f=!0),0<d.length){d=d[0];c=n("div.shareStatus",d);0<c.length?c=c[0]:(c=q.create("div",{className:"shareStatus lotusRightCorner",role:"alert"}),q.place(c,d,"first"));d={message:b,canClose:!0};switch(a){case "error":d.error=!0;break;case "warning":d.warning=!0;break;case "success":d.success=
!0}this.statusContainer&&this.statusContainer.domNode&&!f?this._updateMessageContainer(this.statusContainer,d,c):(this.statusContainer&&this.statusContainer.destroy(),this.statusContainer=this._createMessageContainer(d,c),this.own(l.after(this.statusContainer,"remove",e.hitch(this,this._hideMessageDiv,c),!0)))}}else this.statusContainer&&this.clearPageMessages()},isDirty:function(){return g.some(this.tabs.getChildren(),function(a){return!0===a.isDirty})},setDirty:function(a,b){g.forEach(this.tabs.getChildren(),
e.hitch(this,function(a,b,c){c.actionId==a&&(c.isDirty=b)},a,b))},setSubmitState:function(a){(this.submitInProgress=!0===a)?this.tabs.preventTabSwitching():this.tabs.allowTabSwitching()}})})();return ShareboxDialog});
