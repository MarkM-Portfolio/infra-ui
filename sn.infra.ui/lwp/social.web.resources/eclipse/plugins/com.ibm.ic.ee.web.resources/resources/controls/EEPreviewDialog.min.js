/* Copyright IBM Corp. 2015  All Rights Reserved.                    */
define("dojo dojo/_base/lang dojo/dom-geometry dojo/dom dojo/_base/declare dojo/dom-attr dojo/_base/window dojo/i18n!ic-ee/nls/socialEEStrings dojo/dom-construct dojo/_base/array dojo/dom-style dojo/dom-class dojo/has dojo/on dojo/query dojo/text!ic-ee/controls/templates/EEPreviewDialog.html dojo/topic dojox/html/entities ic-incontext/util/DateFormat com/ibm/lconn/gadget/util/specHelper com/ibm/lconn/gadget/container/iContainer2 ic-incontext/util/html ic-ee/util/misc com/ibm/lconn/layout/people ic-ee/config ic-ee/gadget/GenericEE ic-core/auth ic-eeconfig/config ic-incontext/NetworkDojo ic-incontext/util/misc ic-incontext/util/text ic-ui/controls/FlyoutDialog".split(" "),
function(m,t,h,I,B,r,n,y,e,J,b,q,p,C,u,K,k,L,M,N,O,z,D,E,w,P,F,A,G,Q,S,R){(function(){var H=m.cookie("_eePopupResizingEnabled"),s=A.popupResizing;H&&(s="true"===H);B("com.ibm.social.ee.controls.EEPreviewDialog",R,{fullHeight:!0,sharkRemoval:!0,previouslyLoaded:!1,minWidth:450,verticalMargin:30,scrollMargin:0,topMargin:20,socialObjId:"eePreviewGadget",maxY:0,modified:!1,_hasF:!0,_strings:y.EE_DIALOG,_stringsMsg:y.MESSAGE,container:O,currentNode:null,network:null,inClosePrompt:!1,_firstResize:!0,onCloseDeferred:null,
postCreate:function(){this.inherited(arguments);this.network=G.getInstance({});this.connect(window,"resize",t.hitch(this,function(){this.positioned&&(this._updateHeight(),s&&this._setDialogTopPosition(),this._updateDialogLeftPosition(),this._updateArrowDisplay())}));k.subscribe("com/ibm/social/EEPreviewDialog_resize",t.hitch(this,function(){this.positioned&&(this._updateHeight(),this._setDialogTopPosition())}));this.own(C(window,"scroll",t.hitch(this,this._updateNodePositions)))},initPresentation:function(){return new com.ibm.oneui.controls.EEPreviewDialogPresentation({parent:this,
updateContents:this.updateDialogContents,eeStrings:this._strings,master:this._getMasterPopup()})},updateDialogContents:function(a,c,d){delete c.createContentsDfd;if(a){this.setItem(a);var b=null,f=null,e=null;t.getObject("entry.connections.shortTitle",!1,a)?(b=a.entry.connections.shortTitle,f=a.entry.connections.plainTitle):a.eventHtml?f=b=a.eventHtml:a.context&&(b=a.context.title,e=a.context.itemUrl,f=b);if(null!==b)if(a.context){var l=t.getObject("entry.verb",!1,a);this.setTitle(b,f,e,a.context.eventType,
a.context.actor,l,a.context,c)}else this.setTitle(b,b,null,null,null,null);a.context&&a.context.published&&a.context.updated?this.setTime(a.context.published,a.context.updated):this.hideTime()}if(a.deferred&&0>a.deferred.fired)this.loading(!0),a.deferred.addCallback(c,"onItemLoaded",a,c,d);else{var h=this;(c.createContentsDfd=new m.Deferred).addCallback(function(){h.loading();c.createDialogContents(a,d)})}},onContentSet:function(){this.createContentsDfd&&this.createContentsDfd.callback()},onItemLoaded:function(a,
c,d){this.isOpen(a.around)&&this._presentation.updateContents(a,c,d)},getMasterPopupParams:function(){var a=this.inherited(arguments);a.zIndex=900;return a},createDialogContents:function(a,c){this.isUrlGadget=!1;if(a)if(this.currentNode=a.around,a.context||a.gadgetUrl){var d=a.context,b;d.onCloseDeferred=this.onCloseDeferred;q.add(this._getDomNode(),"lotusui30");if(a.gadgetXmlUrl||a.gadgetUrl){r.get(c,"id")||r.set(c,"id",N.nextDomId());this.siteId&&this.siteId===r.get(c,"id")||(this.siteId=r.get(c,
"id"),this._registerResizeListener());this.container._initialized||(this.container.init(),com.ibm.social.ee.controls.EEPreviewDialog.setupActivityStreamNotification(this.container,this),this.container._initialized=!0);var f=com.ibm.social.ee.controls.EEPreviewDialog.findCurrentAuthUser();d&&f&&(d.authUser=f);this.gadgetHandle&&(this.gadgetHandle.unload(),delete this.gadgetHandle);b={width:"100%"};m.config.isDebug&&v.mixin(b,{userPrefs:{debug:"true"}});var x=!A.ecmOAuth,l=!1;d&&d.eventType&&(l=-1===
d.eventType.indexOf("ecm.")?!1:!0);var p=A.useSSO||l&&x?"false":"true";m.cookie("_oauthEnabled")&&(p=l&&x?"false":m.cookie("_oauthEnabled"));var v=r.get(n.doc.documentElement,"lang"),x=r.get(n.doc.documentElement,"dir"),l="",f=!(f&&f.id);if(netJazzAjaxConfig){var k=m.queryToObject(netJazzAjaxConfig.params);k.country&&(l=k.country);k.lang&&(v=k.lang)}d={placement:c,componentType:"gadget",instanceData:{renderParams:b,eeDataModel:{context:d},viewParams:{useOAuth:p,lang:v,country:l,dir:x,locale:m.locale,
anonymous:f,hideBodyOverflow:!0},errback:v.hitch(this,this.displayErrorMsg,c,this._strings.ERROR_MSG_GENERIC),callback:v.hitch(this,function(){window.setTimeout(v.hitch(this,function(){if(a.gadgetUrl){var b=u("iframe",c)[0];b&&(b.style.height=Math.floor(h.position(this._presentation.scrollNode).h)-20+"px",b.style.width=w.gadgetParams.width-60+"px")}}),200)})}};a.gadgetUrl?(d.instanceData.eeDataModel.url=a.gadgetUrl,this.isUrlGadget=!0):d.definitionUrl=a.gadgetXmlUrl;this.gadgetHandle=this.container.loadWidget(d)}else d&&
(e.empty(c),b=e.create("div",{},c),d.network=G.getInstance({}),d.profileUrl=w.getProfileUrl(),new P(d,b))}else this.displayErrorMsg(c,this._strings.ERROR_MSG_CONTENT_NOT_AVAILABLE)},_registerResizeListener:function(){if(s){var a=com.ibm.lconn.gadget.container.Topics.getSiteTopic(this.siteId,com.ibm.lconn.gadget.container.Topics.GadgetWindow.AFTER_ADJUST_HEIGHT);k.subscribe(a,t.hitch(this,function(a){this.contentResized(a)}))}},_updatePopupPosition:function(){if(this.content){var a=this._getMasterPopup(),
c=a.domNode;b.set(a.wrapper,"width",this.popupWidth+"px");p("ie")&&b.set(a.content,"width",w.gadgetParams.width+"px");this.maxY=h.position(this.lotusMain,!0).y+25;s?(this._updateHeight(),this._setDialogTopPosition(!0)):(this._setDialogTopPosition(!0),this._updateHeight());b.set(c,"right","");b.set(c,"left",this._getPopupHorizontalPosition(c)+"px")}},_getWindowHeight:function(){return 9>p("ie")?document.documentElement.offsetHeight:window.innerHeight},_updateHeight:function(){if(this.content){var a=
this.content.parentNode,c=this._getMasterPopup(),d="absolute"===b.get(c.domNode,"position")?this.maxY+h.position(n.body()).y-this.topMargin:0,a=this._getWindowHeight()-this.verticalMargin-b.get(a,"paddingTop")-b.get(a,"paddingBottom")-b.get(c.wrapper,"borderTopWidth")-b.get(c.wrapper,"borderBottomWidth")-d;0>a&&(a=0);c=b.get(this._presentation.flyoutHeader,"height");if(!p("ie")||9<=p("ie"))c+=b.get(this._presentation.flyoutHeader,"paddingTop")+b.get(this._presentation.flyoutHeader,"paddingBottom");
c=a-c-this.scrollMargin;0>c&&(c=0);!s||this.isUrlGadget?(b.set(this.content,"height",a+"px"),b.set(this._presentation.wrapper,"height",a+"px"),b.set(this._presentation.scrollNode,"height",c+"px")):Math.floor(h.position(this._presentation.contentNode).h)>c?(b.set(this.content,"height",a+"px"),b.set(this._presentation.wrapper,"height",a+"px"),b.set(this._presentation.scrollNode,"height",c+"px"),this.maxHeightReached=!0):(b.set(this.content,"height",""),b.set(this._presentation.wrapper,"height",""),
b.set(this._presentation.scrollNode,"height",""),this.maxHeightReached=!1)}},_encloseArrow:function(a){this.previousArrowParent=a.parentNode;this.arrowPopupNode=e.create("div",{className:this._getEncloseArrowCSSClasses(),visibility:"hidden"},n.body());e.place(a,this.arrowPopupNode)},_getEncloseArrowCSSClasses:function(){return"lotusFlyout"},_getPopupHorizontalPosition:function(a){a="fixed"===a.style.position?h.position(n.body()).x:0;var c=h.position(this.arrowPopupNode,!0);return this.isRTL?c.x-this.popupWidth+
a-this.arrowWidth:c.x+this.arrowWidth+a},_getArrowHorizontalPosition:function(){var a=h.position(this.lotusMain,!0);return this.isRTL?a.x+this.popupWidth+this.arrowWidth+2:a.x+a.w-(this.popupWidth+this.arrowWidth+2)},_getArrowVerticalPosition:function(){var a=h.position(this.currentNode,!0);return a.y+(a.h/2-this.arrowHeight/2)},_setArrowPosition:function(){this.validateCurrentNode();b.set(this.arrowPopupNode,{position:"absolute",borderWidth:"0px",top:this._getArrowVerticalPosition()+"px",left:this._getArrowHorizontalPosition()+
"px"})},_updateNodePositions:function(){this.positioned&&(s||this._setDialogTopPosition(!1),this._updateDialogLeftPosition(),this._updateHeight(),s&&this._setDialogTopPosition(!1),this._updateArrowDisplay())},_updateDialogLeftPosition:function(){if(this.currentNode){this.validateCurrentNode();var a=this._getMasterPopup().domNode;b.set(this.arrowPopupNode,"left",this._getArrowHorizontalPosition()+"px");b.set(a,"right","");b.set(a,"left",this._getPopupHorizontalPosition(a)+"px")}},_updateArrowDisplay:function(){if(this.allowArrowDisplay){var a=
h.position(this.arrowPopupNode,!0).y,c=a+this.arrowHeight,d=this._getMasterPopup().domNode,d=h.position(d,!0).y,g=b.get(this.content,"height"),f=0;p("ie")||(f=7);a>=d+f&&c<=d+g-f?b.set(this.arrowPopupNode,"visibility","visible"):b.set(this.arrowPopupNode,"visibility","hidden")}},_setDialogTopPosition:function(a){var c=this._getMasterPopup().domNode,d=Math.abs(h.position(n.body()).y),g=this.maxY;if(s)if(this.maxHeightReached)d+this.topMargin>=g?("fixed"!==b.get(c,"position")||b.get(c,"top")!==this.topMargin+
"px"||a)&&b.set(c,{top:this.topMargin+"px",position:"fixed"}):("absolute"!==b.get(c,"position")||b.get(c,"top")!==g+"px"||a)&&b.set(c,{top:g+"px",position:"absolute"});else{a=Math.floor(h.position(c).h);var f=(q.contains(this.currentNode,"lotusStream")||!p("descendant")(this.currentNode,n.body())?Math.floor(h.position(this.arrowPopupNode,!0).y):this._getArrowVerticalPosition())+this.arrowHeight/2-a/2,e="absolute",l=this._getWindowHeight()-this.verticalMargin/2;d+this.topMargin>=g?(d=f-d,d<=this.topMargin?
(f=this.topMargin,e="fixed"):d+a>l&&(f=d-(d+a-l),e="fixed")):f<g?(f=g,e="absolute"):f+a>d+l&&(f-=f+a-(d+l),e="absolute");b.set(c,{top:f+"px",position:e})}else d>g?("fixed"!==b.get(c,"position")||a)&&b.set(c,{top:this.topMargin+"px",position:"fixed"}):d+this.topMargin>=g?b.set(c,{top:this.topMargin+"px",position:"fixed"}):("absolute"!==b.get(c,"position")||a)&&b.set(c,{top:g+"px",position:"absolute"})},displayErrorMsg:function(a,c){var b=n.doc;e.empty(a);e.create("div",{className:"lconnEmpty",role:"alert"},
a).appendChild(b.createTextNode(c))},destroy:function(){this.arrowPopupNode&&(this.arrowPopupNode.firstChild&&e.place(this.arrowPopupNode.firstChild,this.previousArrowParent),e.destroy(this.arrowPopupNode));this.inherited(arguments)},close:function(){var a;this.afterClose&&(a=this.afterClose,delete this.afterClose);if(this.modified){if(!this.inClosePrompt){var c=this;this.inClosePrompt=!0;z.promptContentChangedDialog(function(b){b&&(c.modified=!1,c.close(),a&&a());window.setTimeout(function(){c.inClosePrompt=
!1},0)})}}else delete this.afterClose,this.inherited(arguments)},_onBodyClick:function(a){this.inClosePrompt||this.inherited(arguments)},_onKeyPress:function(a){this.inClosePrompt||this.inherited(arguments)},position:function(){this.orientation=m._isBodyLtr()?"R":"L";this.inherited(arguments);this._initializePositioning();this._setArrowPosition();this._updatePopupPosition();this._updateArrowDisplay();this.positioned=!0},_initializePositioning:function(){var a=this._getMasterPopup().arrow;this.arrowPopupNode||
this._encloseArrow(a);this.arrowWidth=b.get(a,"width");this.arrowHeight=b.get(a,"height");b.set(a,{top:0,bottom:"auto"});a=(a=this.content?this.content.parentNode:null)?b.get(a,"paddingRight")+b.get(a,"paddingLeft"):0;this.popupWidth=w.gadgetParams.width+a;this.lotusMain||(this.lotusMain=this.getMainNodeForPage());this.isRTL=!m._isBodyLtr()},getMainNodeForPage:function(){var a=u("div.lotusMain")[0];a||(a=I.byId("lotusMain"));return a},onClose:function(){this.inherited(arguments);this.onCloseDeferred&&
this.onCloseDeferred.callback();this.gadgetHandle&&(this.gadgetHandle.unload(),delete this.gadgetHandle);b.set(this._presentation.msgNode,"display","none");this.arrowPopupNode&&b.set(this.arrowPopupNode,"visibility","hidden");this.allowArrowDisplay=!1},onOpen:function(){this.inherited(arguments);this.allowArrowDisplay=!0;this.onCloseDeferred=new m.Deferred},open:function(a){if(this._getMasterPopup()._showing===this&&this._target!==a&&this.modified){var c=this,b=arguments;this.afterClose=function(){c.open.apply(c,
b)};this.close()}else this.inherited(arguments),D.addMessageToNewWindowLinks(),this._firstResize=!0},next:function(){this.inherited(arguments);"none"!==b.get(this._presentation.nextNode,"display")?this._presentation.nextNode.focus():this._presentation.prevNode.focus()},previous:function(){this.inherited(arguments);"none"!==b.get(this._presentation.prevNode,"display")?this._presentation.prevNode.focus():this._presentation.nextNode.focus()},_validate:function(){this._suspendValidation||this.inherited(arguments)},
updateTarget:function(a){delete this._backupTarget;this.currentNode=this._target=a;this._suspendValidation=!1;this._validate()},validateCurrentNode:function(){this._target&&!p("descendant")(this._target,n.body())&&this._backupTarget&&this.updateTarget(this._backupTarget)},scrollTop:function(){this._presentation.scrollNode.scrollTop=0},scrollBottom:function(){this._presentation.scrollNode.scrollTop=9999},contentResized:function(a){this._presentation&&(u("iframe",this._presentation.contentNode).style("height",
isNaN(a)?a:a+"px"),this._updateHeight(),this._setDialogTopPosition(),this._firstResize&&(this._presentation.focusFirstLink(this.content),this._firstResize=!1))}});B("com.ibm.oneui.controls.EEPreviewDialogPresentation",com.ibm.oneui.controls.FlyoutDialogPresentation,{eeStrings:null,templateString:K,commonStrings:y.common,title:"",adhocEventTitles:{},MAX_LINK_LENGTH:25,postCreate:function(){this.inherited(arguments);var a=e.create("a",{role:"button",className:"backTopHidden",href:"javascript:;","aria-hidden":"true",
tabindex:0},this.wrapper);b.set(a,{top:"-9999px",position:"absolute"});a.appendChild(n.doc.createTextNode(this.messages.goBack));C(a,"focus",t.hitch(this,"backToTop"));this.createAdhocTitleMapping()},createAdhocTitleMapping:function(){this.adhocEventTitles["profiles.status.updated"]=this.eeStrings.TITLE_SU;this.adhocEventTitles["profiles.colleague.created"]=this.eeStrings.TITLE_NI},_setAriaStringsOnTitleNode:function(a){r.set(this.titleNode,"title",a?a:"");r.set(this.titleNode,"aria-label",a?a:"")},
setTitle:function(a,c,b,g,f,h){this._setAriaStringsOnTitleNode(c);F.getUser()&&F.getUser().isExternal&&(a=z.removeProfileLinks(a));if(g&&this.adhocEventTitles[g]&&"bump"!==h){if(e.empty(this.titleNode),a=this._formatUserName(f),a=m.string.substitute(this.adhocEventTitles[g],{author:a}),this.titleNode.innerHTML=a,f=f.displayName)c=m.string.substitute(this.adhocEventTitles[g],{author:f}),this._setAriaStringsOnTitleNode(c)}else if(b)e.empty(this.titleNode),e.create("a",{href:b,title:a||"",target:"_blank",
className:"bidiAware"},this.titleNode).appendChild(n.doc.createTextNode(a||""));else{e.empty(this.titleNode);var l=com.ibm.social.incontext.util;this.titleNode.innerHTML=a;l.text.breakStringHTML(this.titleNode);var k=this;u("a",this.titleNode).forEach(function(a){a.target="_blank";q.remove(a,"entry");if(!q.contains(a.parentNode,"vcard")){var c=l.html.htmlText(a),b=L.encode(c);b&&(a.title=k.eeStrings.OPEN_LINK?m.string.substitute(k.eeStrings.OPEN_LINK,{title:c}):c,b=l.text.trimToLength(b,k.MAX_LINK_LENGTH),
a.innerHTML=b)}});u("span",this.titleNode).forEach(function(a){q.remove(a,"profiles entry")})}lconn.core.globalization.bidiUtil.enforceTextDirectionOnPage(this.wrapper)},_formatUserName:function(a){var c=e.create("div"),b,g;g=e.create("span",{className:"vcard"},c);g.appendChild(n.doc.createTextNode(a.displayName));E.createLink&&(b=E.createLink({userid:D.getItemId(a.id),state:a.state,name:a.displayName,email:a.email}))&&(m.removeAttr(b,"aria-describedby"),q.add(b,"eeActionLinks"),r.set(b,"target",
"_blank"),r.set(b,"title",m.string.substitute(this.commonStrings.PERSON_TITLE,{user:a.displayName})),e.empty(g),g.appendChild(b));return c.innerHTML},setTime:function(a,c){e.empty(this.timeNode);var d="false"===c?this.messages.timestamp.created:this.messages.timestamp.updated,g=Q.date.convertAtomDate(a),d=(new M(g)).formatByAge(d);e.create("span",{},this.timeNode).appendChild(n.doc.createTextNode(d));b.set(this.timeNode,"display","");b.set(this.timeNode,"borderLeftStyle","")},hideTime:function(){m.html.set(this.timeNode,
"&nbsp;");b.set(this.timeNode,"borderLeftStyle","none")},setItem:function(a){this.item=a},backToTop:function(a){this.focusFirstLink()},loading:function(a){a&&this.setTitle(this.eeStrings.LOADING);e.empty(this.contentNode);q.add(this.contentNode,"lotusFlyoutInner");z.showLoading(this.contentNode)},focusFirstLink:function(a){a=u("a",a?a:this.domNode);var c=[];J.forEach(a,function(a,e){"none"!==b.get(a,"display")&&!q.contains(a,"lotusAltText")&&!q.contains(a,"backTopHidden")&&q.contains(a,"fn")&&q.contains(a,
"url")&&c.push(a)});a=null;a=0<c.length?c[0]:this.metaCloseInput;dijit.focus(a);this._firstFocusItem=a}});com.ibm.social.ee.controls.EEPreviewDialog.findCurrentAuthUser=function(){var a=null;langModule.getObject("lconn.homepage.global")?langModule.isFunction(langModule.getObject("lconn.homepage.global.getUserId"))&&(a={id:lconn.homepage.global.getUserId(),name:langModule.getObject("lconn.homepage.userName")}):langModule.getObject("widgetUserInfo")?a={id:langModule.getObject("widgetUserInfo.userId"),
name:langModule.getObject("widgetUserInfo.displayName")}:langModule.getObject("profilesData.loggedInUser")&&(a={id:langModule.getObject("currentUserGuid"),name:langModule.getObject("profilesData.loggedInUser.displayName")});return a};com.ibm.social.ee.controls.EEPreviewDialog.setupActivityStreamNotification=function(a,b){com.ibm.social.ee.controls.EEPreviewDialog._notificationInitialized||a.getCommonContainer().then(function(a){k.subscribe("com/ibm/social/ee/event/updateActivityEntry",function(a,
d){p("descendant")(b._target,document.body)&&(b._backupTarget=b._target.parentNode);b._suspendValidation=!0;var e=[a];d&&e.push(d);k.publish("com/ibm/social/as/event/addactivityentry",e)});k.subscribe("com/ibm/social/ee/event/closePopup",function(){p("descendant")(b._target,document.body)&&b.close()});k.subscribe("com/ibm/social/ee/event/setDirty",function(a){b.modified=a});k.subscribe("com/ibm/social/ee/event/scrollTop",function(){window.setTimeout(function(){b.scrollTop()},0)});k.subscribe("com/ibm/social/ee/event/scrollBottom",
function(){window.setTimeout(function(){b.scrollBottom()},0)});com.ibm.social.ee.controls.EEPreviewDialog._notificationInitialized=!0})}})();return EEPreviewDialog});
